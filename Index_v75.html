<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Index v70 Fixed2 Stable — Prediksi HDP & O/U</title>
<style>
:root{--bg:#041018;--panel:#071826;--accent:#0b74de;--muted:#8faab7;--good:#2ecc71;--warn:#ffd166;--bad:#ef476f;--text:#dff3ff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:18px auto;padding:18px}
h1{font-size:20px;margin:0 0 6px}
.panel{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1 1 260px;min-width:220px}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #22333f;background:#08131a;color:#fff;font-size:14px}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
button.ghost{background:transparent;border:1px solid #233645;color:var(--text);padding:6px 8px;border-radius:6px}
.small{font-size:12px;color:var(--muted)}
.result{background:#06121a;padding:10px;border-radius:8px;border:1px dashed rgba(255,255,255,0.03);font-family:monospace;white-space:pre-wrap}
.card{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#061922;margin-bottom:8px}
canvas{background:transparent;border-radius:6px}
.progress-wrap{background:#07202a;border-radius:10px;padding:6px;margin-top:8px}
.progress-fill{height:18px;border-radius:8px;width:0%;transition:width .5s}
.strength-bar{height:14px;border-radius:8px;background:#0a2230;overflow:hidden;margin-top:6px}
.strength-fill{height:14px;border-radius:8px 0 0 8px;background:var(--accent);width:0%;transition:width .5s}
#saveBtn{position:fixed;right:18px;bottom:18px;z-index:999;background:var(--accent);border-radius:8px;padding:8px 12px;color:#fff;cursor:pointer}
.indicator{display:flex;align-items:center;gap:8px}
.indicator .dot{width:12px;height:12px;border-radius:50%}
.ind-green{background:var(--good)}.ind-amber{background:var(--warn)}.ind-red{background:var(--bad)}
@media (max-width:720px){.col{flex-basis:100%}}
</style>
</head>
<body>
<div class="container">
  <h1>Index v70 Fixed2 Stable — Prediksi HDP & O/U</h1>
  <p class="small">One-column focus • dark mode • Bahasa campur (ID/EN). Semua tombol aktif. Tidak ada demo data.</p>

  <div class="panel">
    <div class="row">
      <div class="col"><label>Mode</label><select id="presetMode"><option value="auto">Auto</option><option value="league">League</option><option value="cup">Cup</option><option value="custom">Custom</option></select></div>
      <div class="col"><label>Date</label><input id="matchDate" type="date"></div>
    </div>
    <label>Match (Home vs Away)</label><input id="matchName" type="text" placeholder="Contoh: Atalanta vs Lazio">
  </div>

  <div class="panel">
    <h3 style="margin:0">Team core stats (minimal)</h3>
    <div class="row">
      <div class="col">
        <label>Home Team</label><input id="teamHome" type="text" placeholder="Home FC">
        <label>Rating (SofaScore avg)</label><input id="ratingHome" type="number" step="0.01" placeholder="6.9">
        <label>Form Last5 (0-1)</label><input id="formHome" type="number" step="0.01" placeholder="0.68">
        <label>H2H (e.g. W,D,L,...)</label><input id="h2hInput" type="text" placeholder="W,D,W,D,L">
      </div>
      <div class="col">
        <label>Away Team</label><input id="teamAway" type="text" placeholder="Away FC">
        <label>Rating (SofaScore avg)</label><input id="ratingAway" type="number" step="0.01" placeholder="6.4">
        <label>Form Last5 (0-1)</label><input id="formAway" type="number" step="0.01" placeholder="0.55">
        <label>H2H win rate (optional)</label><input id="h2hRate" type="number" step="0.01" placeholder="">
      </div>
    </div>

    <div style="margin-top:8px">
      <button id="btnAutoH2H" class="ghost">Auto H2H → fill rate</button>
      <button id="btnAutoCR" class="ghost">Auto Conversion Rate</button>
      <button id="btnAutoTI" class="ghost">Auto TI (tackle+inter)</button>
    </div>

    <h4 style="margin-top:10px">Key stats</h4>
    <div class="row">
      <div class="col"><label>xG / game (Home)</label><input id="xgHome" type="number" step="0.01" placeholder="1.25"></div>
      <div class="col"><label>xG / game (Away)</label><input id="xgAway" type="number" step="0.01" placeholder="1.05"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>SOT / game (Home)</label><input id="sotHome" type="number" step="0.01" placeholder="4.2"></div>
      <div class="col"><label>SOT / game (Away)</label><input id="sotAway" type="number" step="0.01" placeholder="3.4"></div>
    </div>

    <h4 style="margin-top:10px">Tackles + Interceptions (auto TI)</h4>
    <div class="row">
      <div class="col"><label>Home Tackles</label><input id="tackleHome" type="number" step="0.1" placeholder="18.3"><label>Home Interceptions</label><input id="interHome" type="number" step="0.1" placeholder="8.7"></div>
      <div class="col"><label>Away Tackles</label><input id="tackleAway" type="number" step="0.1" placeholder="15.1"><label>Away Interceptions</label><input id="interAway" type="number" step="0.1" placeholder="7.2"></div>
    </div>
    <div style="margin-top:8px">
      <label>TI Home (auto)</label><input id="tiHome" type="number" readonly>
      <label>TI Away (auto)</label><input id="tiAway" type="number" readonly>
    </div>

    <h4 style="margin-top:10px">Absences (count only)</h4>
    <div class="row">
      <div class="col"><label>Home DF absent</label><input id="absDfHome" type="number" value="0"><label>Home MF absent</label><input id="absMfHome" type="number" value="0"><label>Home FW absent</label><input id="absFwHome" type="number" value="0"></div>
      <div class="col"><label>Away DF absent</label><input id="absDfAway" type="number" value="0"><label>Away MF absent</label><input id="absMfAway" type="number" value="0"><label>Away FW absent</label><input id="absFwAway" type="number" value="0"></div>
    </div>

    <h4 style="margin-top:10px">Clean sheet & GA (click calc)</h4>
    <div class="row">
      <div class="col"><label>CS count (Home)</label><input id="csCountHome" type="number" placeholder="3"><label>Matches (Home)</label><input id="csMatchesHome" type="number" placeholder="10"><label>CSR Home</label><input id="csHome" type="number" readonly><button id="btnCalcCSHome" class="ghost">Calc CSR Home</button></div>
      <div class="col"><label>CS count (Away)</label><input id="csCountAway" type="number" placeholder="2"><label>Matches (Away)</label><input id="csMatchesAway" type="number" placeholder="10"><label>CSR Away</label><input id="csAway" type="number" readonly><button id="btnCalcCSAway" class="ghost">Calc CSR Away</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Goals conceded (Home)</label><input id="gcHomeCount" type="number" placeholder="12"><label>Matches (Home)</label><input id="gcMatchesHome" type="number" placeholder="10"><label>GA / game Home</label><input id="gcHome" type="number" readonly><button id="btnCalcGAHome" class="ghost">Calc GA Home</button></div>
      <div class="col"><label>Goals conceded (Away)</label><input id="gcAwayCount" type="number" placeholder="14"><label>Matches (Away)</label><input id="gcMatchesAway" type="number" placeholder="10"><label>GA / game Away</label><input id="gcAway" type="number" readonly><button id="btnCalcGAAway" class="ghost">Calc GA Away</button></div>
    </div>
  </div>

  <div class="panel">
    <h3 style="margin:0">Odds & model</h3>
    <div class="row">
      <div class="col"><label>HDP Line</label><input id="hdpLine" type="number" step="0.25" value="0.25"></div>
      <div class="col"><label>OU Line</label><input id="ouLine" type="number" step="0.25" value="2.5"></div>
      <div class="col"><label>MC runs</label><input id="mcRuns" type="number" value="40000"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>HDP Home Open</label><input id="hdpHomeOpen" type="number" step="0.01"></div>
      <div class="col"><label>HDP Home Now</label><input id="hdpHomeNow" type="number" step="0.01"></div>
      <div class="col"><label>HDP Away Open</label><input id="hdpAwayOpen" type="number" step="0.01"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>HDP Away Now</label><input id="hdpAwayNow" type="number" step="0.01"></div>
      <div class="col"><label>OU Over Open</label><input id="ouOverOpen" type="number" step="0.01"></div>
      <div class="col"><label>OU Over Now</label><input id="ouOverNow" type="number" step="0.01"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>OU Under Open</label><input id="ouUnderOpen" type="number" step="0.01"></div>
      <div class="col"><label>OU Under Now</label><input id="ouUnderNow" type="number" step="0.01"></div>
      <div class="col"><label>ρ (rho)</label><input id="rho" type="number" step="0.01" value="0.12"></div>
    </div>
    <div style="margin-top:10px">
      <button id="btnAnalyze">Analisis</button>
      <button id="btnReset" class="ghost">Reset</button>
      <button id="btnDownload" class="ghost">Download CSV</button>
    </div>
  </div>

  <div class="panel">
    <h3 style="margin:0">Result & recommendations</h3>
    <div id="summary" class="result" style="margin-top:8px">Isi input lalu klik Analisis. (No demo)</div>

    <div style="margin-top:10px">
      <div><b>Home Attack</b> <span id="atkHomeVal" style="float:right">-</span></div>
      <div class="strength-bar"><div id="atkHomeBar" class="strength-fill"></div></div>
      <div style="margin-top:8px"><b>Home Defense</b> <span id="defHomeVal" style="float:right">-</span></div>
      <div class="strength-bar"><div id="defHomeBar" class="strength-fill"></div></div>

      <div style="height:8px"></div>

      <div style="margin-top:8px"><b>Away Attack</b> <span id="atkAwayVal" style="float:right">-</span></div>
      <div class="strength-bar"><div id="atkAwayBar" class="strength-fill"></div></div>
      <div style="margin-top:8px"><b>Away Defense</b> <span id="defAwayVal" style="float:right">-</span></div>
      <div class="strength-bar"><div id="defAwayBar" class="strength-fill"></div></div>
    </div>

    <div style="margin-top:12px">
      <label class="small">Confidence</label>
      <div class="progress-wrap"><div id="confFill" class="progress-fill"></div></div>
      <div id="confText" class="small" style="text-align:right">Confidence: 0%</div>
    </div>

    <div id="valueIndicator" style="margin-top:12px;display:flex;gap:10px;align-items:center">
      <div id="valuePill" class="value-pill" style="background:#23333b">Value: N/A</div>
      <div id="valueText" class="small">Indicator after analysis</div>
    </div>

    <div id="oddsStat" style="margin-top:12px"></div>
    <div id="trapBox" class="result" style="margin-top:10px;display:none"></div>
    <div id="recs" style="margin-top:8px"></div>

    <div style="margin-top:12px"><canvas id="hist" width="900" height="160"></canvas></div>
    <div id="debug" class="result" style="margin-top:8px;background:#07121b"></div>
  </div>

  <p class="small">Tip: isi CSR/GA/xG/SOT/TI & absences untuk akurasi terbaik. Preset Auto menyesuaikan alpha/ρ.</p>
</div>

<button id="saveBtn" title="Save inputs locally">💾 Save Input</button>

<script>
/* Helper */
function dom(id){return document.getElementById(id)}
function safe(v,d=NaN){const x=parseFloat(v);return isNaN(x)?d:x}
function clamp(v,a,b){return isNaN(v)?a:Math.max(a,Math.min(b,v))}
function pct(v){return isNaN(v)?'-':(100*v).toFixed(1)+'%'}
function poisson(lambda){let L=Math.exp(-lambda),p=1,k=0;while(p>L){k++;p*=Math.random();if(k>10000)break;}return k-1}

/* Event binding on load */
document.addEventListener('DOMContentLoaded', ()=>{
  ['btnCalcCSHome','btnCalcCSAway','btnCalcGAHome','btnCalcGAAway','btnAutoH2H','btnAutoCR','btnAutoTI','btnAnalyze','btnReset','btnDownload'].forEach(id=>{
    const el=dom(id); if(el) el.addEventListener('click', handlers[id] || function(){});
  });
  dom('presetMode')?.addEventListener('change', presetApply);
  dom('saveBtn').addEventListener('click', saveInputs);
  loadInputs();
  if(!dom('hist')?.getContext) dom('hist').parentNode.innerText='⚠️ Histogram not available';
});

/* Map */

const handlers = {

  btnAutoH2H: autoH2H, btnAutoCR: autoCR, btnAutoTI: autoTI, btnAnalyze: analyzeMatch,

  btnReset: resetAll, btnDownload: downloadCSV, btnCalcCSHome: calcCSHome, btnCalcCSAway: calcCSAway, btnCalcGAHome: calcGAHome, btnCalcGAAway: calcGAAway

};



/* Auto calculations */

function autoH2H(){const s=(dom('h2hInput').value||'').toUpperCase();const parts=s.replace(/[^WDL, ]/g,'').split(/[, ]+/).filter(Boolean);if(parts.length===0){alert('Isi H2H string');return;}const wins=parts.filter(p=>p==='W').length;dom('h2hRate').value=(wins/parts.length).toFixed(2);saveInputs();}

function autoCR(){const gh=safe(dom('xgHome').value,NaN),sh=safe(dom('sotHome').value,NaN),ga=safe(dom('xgAway').value,NaN),sa=safe(dom('sotAway').value,NaN);let msg='';if(sh>0 && !isNaN(gh)) msg+='CR Home ≈ '+(gh/sh).toFixed(2)+'\n';if(sa>0 && !isNaN(ga)) msg+='CR Away ≈ '+(ga/sa).toFixed(2);if(msg==='') msg='Not enough xG/SOT';alert(msg)}

function autoTI(){const tH=safe(dom('tackleHome').value,0),iH=safe(dom('interHome').value,0),tA=safe(dom('tackleAway').value,0),iA=safe(dom('interAway').value,0);const tiH=+(tH+iH).toFixed(1),tiA=+(tA+iA).toFixed(1);dom('tiHome').value=tiH;dom('tiAway').value=tiA;saveInputs();alert('TI set');}



/* CSR/GA calculators */

function calcCSHome(){const cs=safe(dom('csCountHome').value,0),m=safe(dom('csMatchesHome').value,0);if(m<=0){alert('Enter matches Home');return;}dom('csHome').value=(clamp(cs/m,0,1)).toFixed(2);saveInputs();}

function calcCSAway(){const cs=safe(dom('csCountAway').value,0),m=safe(dom('csMatchesAway').value,0);if(m<=0){alert('Enter matches Away');return;}dom('csAway').value=(clamp(cs/m,0,1)).toFixed(2);saveInputs();}

function calcGAHome(){const g=safe(dom('gcHomeCount').value,0),m=safe(dom('gcMatchesHome').value,0);if(m<=0){alert('Enter matches Home');return;}dom('gcHome').value=(g/m).toFixed(2);saveInputs();}

function calcGAAway(){const g=safe(dom('gcAwayCount').value,0),m=safe(dom('gcMatchesAway').value,0);if(m<=0){alert('Enter matches Away');return;}dom('gcAway').value=(g/m).toFixed(2);saveInputs()}



/* Model */

function computeAttack(xg,sot,form,rating,absFw,absMf){const base=0.45*(xg||1.0)+0.20*((sot||3)/5)+0.12*(form||0.5)+0.08*(rating?((rating-6)/1.5):0);const penalty=Math.max(0.6,1-0.06*(absFw||0)-0.03*(absMf||0));return Math.max(0.12,base*penalty)}

function computeDefense(cs,ga,absDf,ti){const csAdj=1-clamp((cs||0)*0.35,0,0.6);const gaAdj=1+0.22*(ga||1.2);const absAdj=1+0.08*(absDf||0);const tiAdj=1-clamp((ti||0)/60,0,0.25);return clamp(csAdj*gaAdj*absAdj*tiAdj,0.45,3.0)}

function balanceLambda(lh,la){const avg=(lh+la)/2;const adjust=avg>2.8?0.87:avg>2.2?0.93:1.0;return [lh*adjust,la*adjust]}

function sampleBivariate(lambdaH,lambdaA,rho){const shared=Math.max(0,rho*Math.min(lambdaH,lambdaA));const hPart=Math.max(0,lambdaH-shared);const aPart=Math.max(0,lambdaA-shared);const sh=poisson(shared);return [sh+poisson(hPart),sh+poisson(aPart)]}



/* Prob helpers */

function probCoverFromScores(scoreFreq,handicap,runs){let win=0,push=0,lose=0;for(const sc in scoreFreq){const v=scoreFreq[sc];const [gh,ga]=sc.split('-').map(x=>parseInt(x));const diff=gh-ga-handicap;if(diff>0) win+=v;else if(diff===0) push+=v;else lose+=v;}return (win+0.5*push)/runs}

function probOUFromTotals(totals,line,runs){let over=0,under=0;const isInt=Number.isInteger(line);for(const t in totals){const g=parseInt(t),v=totals[t];if(isInt){if(g>line) over+=v;else if(g<line) under+=v;else {over+=0.5*v;under+=0.5*v;}} else {if(g>line) over+=v;else under+=v;}}return {over:over/runs,under:under/runs}}

function impliedProb(odds){if(!odds||odds<=0) return null;return 1/odds}



/* Auto param adjust */

function autoParams(xgH,xgA,formH,formA,preset){const xgDiff=Math.abs(xgH-xgA);const formDiff=Math.abs((formH||0.5)-(formA||0.5));let alpha=clamp(0.10+(xgDiff*0.08)+(formDiff*0.06),0.06,0.22);let rho=clamp(0.08+Math.min(0.25,(1-Math.exp(-Math.max(0,xgDiff*1.5)))*0.20),0.05,0.28);if(preset==='cup'){alpha=Math.min(0.20,alpha+0.03);rho=Math.min(0.32,rho+0.03);}if(preset==='custom'){alpha=parseFloat(dom('alpha')?.value)||alpha;rho=parseFloat(dom('rho')?.value)||rho;}return {alpha,rho}}



/* Analyze (same as previous) */

let lastCSV='';

function analyzeMatch(){ try{ const home=(dom('teamHome').value||'').trim(), away=(dom('teamAway').value||'').trim(); if(!home||!away){alert('Isi nama tim Home & Away');return;} const ratingH=safe(dom('ratingHome').value,6.5), ratingA=safe(dom('ratingAway').value,6.3); let formH=safe(dom('formHome').value,NaN), formA=safe(dom('formAway').value,NaN); if(!Number.isFinite(formH)) formH=0.5; if(!Number.isFinite(formA)) formA=0.5; let h2hRate=safe(dom('h2hRate').value,NaN); if(!Number.isFinite(h2hRate)){const parts=(dom('h2hInput').value||'').toUpperCase().replace(/[^WDL, ]/g,'').split(/[, ]+/).filter(Boolean); if(parts.length>0) h2hRate=parts.filter(p=>p==='W').length/parts.length;} if(!Number.isFinite(h2hRate)) h2hRate=0.5; const xgH=safe(dom('xgHome').value,ratingH/5), xgA=safe(dom('xgAway').value,ratingA/5); const sotH=safe(dom('sotHome').value,4), sotA=safe(dom('sotAway').value,3); const csH=safe(dom('csHome').value,0.28), csA=safe(dom('csAway').value,0.26); const gaH=safe(dom('gcHome').value,1.15), gaA=safe(dom('gcAway').value,1.30); const absDfH=Math.max(0,safe(dom('absDfHome').value,0)), absMfH=Math.max(0,safe(dom('absMfHome').value,0)), absFwH=Math.max(0,safe(dom('absFwHome').value,0)); const absDfA=Math.max(0,safe(dom('absDfAway').value,0)), absMfA=Math.max(0,safe(dom('absMfAway').value,0)), absFwA=Math.max(0,safe(dom('absFwAway').value,0)); const tiH=safe(dom('tiHome').value, safe(dom('tackleHome').value,0)+safe(dom('interHome').value,0)); const tiA=safe(dom('tiAway').value, safe(dom('tackleAway').value,0)+safe(dom('interAway').value,0)); const preset=dom('presetMode').value||'auto'; const ap=autoParams(xgH,xgA,formH,formA,preset); const alpha=(preset==='auto')?ap.alpha:(safe(dom('alpha')?.value,ap.alpha)); const rho=(preset==='auto')?ap.rho:(safe(dom('rho')?.value,ap.rho)); const runs=Math.max(2000,parseInt(dom('mcRuns').value||40000)); const atkH=computeAttack(xgH,sotH,formH,ratingH,absFwH,absMfH); const atkA=computeAttack(xgA,sotA,formA,ratingA,absFwA,absMfA); const defH=computeDefense(csH,gaH,absDfH,tiH); const defA=computeDefense(csA,gaA,absDfA,tiA); const leagueAvg=Math.max(0.55,(xgH+xgA)/2); let lambdaH=leagueAvg*(atkH/Math.max(0.3,leagueAvg))*(1/defA); let lambdaA=leagueAvg*(atkA/Math.max(0.3,leagueAvg))*(1/defH); const ratingBaseH=(ratingH/5)*leagueAvg; const ratingBaseA=(ratingA/5)*leagueAvg; lambdaH=alpha*ratingBaseH+(1-alpha)*lambdaH; lambdaA=alpha*ratingBaseA+(1-alpha)*lambdaA; const h2hBoost=clamp((h2hRate-0.5)*0.16,-0.10,0.10); lambdaH=Math.max(0.03,lambdaH*(1+h2hBoost)); lambdaA=Math.max(0.03,lambdaA*(1-h2hBoost)); [lambdaH,lambdaA]=balanceLambda(lambdaH,lambdaA); const scoreFreq={}, totals={}, runsInt=runs; let homeWins=0, draws=0, awayWins=0; for(let i=0;i<runsInt;i++){ const [gh,ga]=sampleBivariate(lambdaH,lambdaA,rho); const k=`${gh}-${ga}`; scoreFreq[k]=(scoreFreq[k]||0)+1; totals[gh+ga]=(totals[gh+ga]||0)+1; if(gh>ga) homeWins++; else if(gh===ga) draws++; else awayWins++; } const pHome=homeWins/runsInt, pDraw=draws/runsInt, pAway=awayWins/runsInt; const avgH=Object.entries(scoreFreq).reduce((s,[sc,v])=>s+parseInt(sc.split('-')[0])*v,0)/runsInt; const avgA=Object.entries(scoreFreq).reduce((s,[sc,v])=>s+parseInt(sc.split('-')[1])*v,0)/runsInt; const ouLine=safe(dom('ouLine').value,2.5); const ouProbs=probOUFromTotals(totals,ouLine,runsInt); const hdpLine=safe(dom('hdpLine').value,0.25); const coverHome=probCoverFromScores(scoreFreq,hdpLine,runsInt); const coverAway=1-coverHome; const imp={hdpHome:impliedProb(safe(dom('hdpHomeNow').value,NaN)), hdpAway:impliedProb(safe(dom('hdpAwayNow').value,NaN)), ouOver:impliedProb(safe(dom('ouOverNow').value,NaN)), ouUnder:impliedProb(safe(dom('ouUnderNow').value,NaN))}; function edge(m,imp){ if(!imp||!isFinite(imp)) return null; return m-imp } const eH=edge(coverHome,imp.hdpHome), eA=edge(coverAway,imp.hdpAway), eOver=edge(ouProbs.over,imp.ouOver), eUnder=edge(ouProbs.under,imp.ouUnder); const avgEdgeHDP=((eH===null?0:eH)+(eA===null?0:eA))/2, avgEdgeOU=((eOver===null?0:eOver)+(eUnder===null?0:eUnder))/2; const combinedIndex=(0.6*avgEdgeHDP)+(0.4*avgEdgeOU); let valueLabel='N/A', valueColor='#23333b', valueText='Market odds incomplete'; if(isFinite(combinedIndex)){ const vpc=combinedIndex*100; if(vpc>3){ valueLabel='VALUE'; valueColor='#114b2b'; valueText=`Model stronger than market ${(vpc).toFixed(2)}%`; } else if(vpc<-3){ valueLabel='NO VALUE'; valueColor='#5a0b16'; valueText=`Market stronger ${(-vpc).toFixed(2)}%`; } else { valueLabel='FAIR'; valueColor='#574a12'; valueText=`Market ≈ Model (${vpc.toFixed(2)}%)`; } } const topProb=Math.max(pHome,pAway,ouProbs.over,ouProbs.under); const conf=Math.round(topProb*100); dom('confFill').style.width=conf+'%'; dom('confFill').style.background=conf<45? '#ef476f':(conf<65? '#ffd166':'#00ff9d'); dom('confText').textContent='Confidence: '+conf+'%'; let summary=`Match: ${home} vs ${away}\n`; summary+=`λ: Home ${lambdaH.toFixed(2)} | Away ${lambdaA.toFixed(2)}\n`; summary+=`Atk H:${atkH.toFixed(2)} A:${atkA.toFixed(2)} | Def H:${defH.toFixed(2)} A:${defA.toFixed(2)}\n`; summary+=`Exp goals: H ${avgH.toFixed(2)} | A ${avgA.toFixed(2)}\n`; summary+=`1X2 Model: Home ${pct(pHome)} Draw ${pct(pDraw)} Away ${pct(pAway)}\n`; summary+=`OU(${ouLine}) Over ${pct(ouProbs.over)} Under ${pct(ouProbs.under)}\n`; summary+=`HDP(${hdpLine}) Home ${pct(coverHome)} Away ${pct(coverAway)}\n`; summary+=`Alpha:${alpha.toFixed(2)} Rho:${rho.toFixed(2)} Runs:${runsInt}\n`; summary+=`Combined Value Index: ${(combinedIndex*100).toFixed(2)}% → ${valueLabel}\n`; summary+=`${valueText}\n`; summary+=`Absent H:${absDfH}/${absMfH}/${absFwH} • A:${absDfA}/${absMfA}/${absFwA}\n`; summary+=`TI H:${tiH} TI A:${tiA}\n`; summary+=`Confidence: ${conf}%`; dom('summary').textContent=summary; updateStrength('atkHomeBar','atkHomeVal',atkH); updateStrength('defHomeBar','defHomeVal',(1/defH)*10); updateStrength('atkAwayBar','atkAwayVal',atkA); updateStrength('defAwayBar','defAwayVal',(1/defA)*10); dom('valuePill').style.background=valueColor; dom('valuePill').textContent=valueLabel; dom('valueText').textContent=valueText; dom('trapBox').style.display='block'; dom('trapBox').textContent=`Market diagnostic: ${(combinedIndex*100).toFixed(2)}% → ${valueLabel}`; const candidates=[]; function edgeVal(m,imp){if(!imp) return null; return m-imp} candidates.push({tag:`HDP Home ${hdpLine}`,prob:coverHome,edge:edgeVal(coverHome,imp.hdpHome)}); candidates.push({tag:`HDP Away ${-hdpLine}`,prob:coverAway,edge:edgeVal(coverAway,imp.hdpAway)}); candidates.push({tag:`OU Over ${ouLine}`,prob:ouProbs.over,edge:edgeVal(ouProbs.over,imp.ouOver)}); candidates.push({tag:`OU Under ${ouLine}`,prob:ouProbs.under,edge:edgeVal(ouProbs.under,imp.ouUnder)}); candidates.forEach(c=>{c.score=(c.prob*0.7)+((c.edge!==null)?(c.edge*0.3):0)}); candidates.sort((a,b)=>b.score-a.score); dom('recs').innerHTML=''; candidates.slice(0,2).forEach(t=>{const div=document.createElement('div');div.className='card';div.innerHTML=`<div style="font-weight:700">${t.tag}</div><div style="text-align:right">${pct(t.prob)}<div class="small">${t.edge===null?'No market odds':('edge '+(t.edge*100).toFixed(2)+'%')}</div></div>`;dom('recs').appendChild(div)}); renderHistogram(totals); dom('debug').textContent=`avgGoals H:${avgH.toFixed(2)} A:${avgA.toFixed(2)} | λH:${lambdaH.toFixed(2)} λA:${lambdaA.toFixed(2)}`; let csv='score,count,prob\n';Object.keys(scoreFreq).sort().forEach(k=>{const c=scoreFreq[k];csv+=`${k},${c},${(c/runsInt).toFixed(6)}\n`}); lastCSV=csv; saveSnapshot(); renderOddsStat({avgEdgeHDP,avgEdgeOU,combinedIndex,imp,coverHome,coverAway,ouProbs}); }catch(e){console.error(e);alert('Error saat analisis — cek console.')} }



/* render odds-stat indicator */

function renderOddsStat(ctx){const container=dom('oddsStat');container.innerHTML='';const ci=ctx.combinedIndex;const absci=Math.abs(ci*100);let status='Neutral',cls='ind-amber',text='Stats ~ Market';if(!isFinite(ci)){status='No market';cls='ind-amber';text='Odds incomplete'}else if(absci<2.5){status='Concordant';cls='ind-green';text='Stats support market'}else if(absci<6){status='Caution';cls='ind-amber';text='Small diff'}else{status='Discordant';cls='ind-red';text='Stats oppose market — value potential'};const arrow=ci>0?'⬆️ Model>Market':(ci<0?'⬇️ Market>Model':'→');const el=document.createElement('div');el.className='indicator';el.innerHTML=`<div class="dot ${cls}"></div><div><b>${status}</b> • ${text}<div style="font-size:13px;margin-top:4px">${arrow} • ΔHDP:${(ctx.avgEdgeHDP*100).toFixed(2)}% ΔOU:${(ctx.avgEdgeOU*100).toFixed(2)}%</div></div>`;container.appendChild(el)}



/* UI helpers */

function updateStrength(barId,valId,score){const pctv=Math.max(4,Math.min(95,(score/2.5)*100));dom(barId).style.width=pctv+'%';dom(valId).textContent=score.toFixed(2)}

function renderHistogram(totals){const c=dom('hist');if(!c||!c.getContext) return;const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);const keys=Object.keys(totals).map(x=>parseInt(x)).sort((a,b)=>a-b);if(keys.length===0) return;const maxV=Math.max(...Object.values(totals));const pad=30;const barW=Math.max(10,(c.width-pad*2)/keys.length-4);keys.forEach((k,i)=>{const v=totals[k];const h=(v/maxV)*(c.height-40);ctx.fillStyle='#0b74de';ctx.fillRect(pad+i*(barW+4),c.height-30-h,barW,h);ctx.fillStyle='#9fb3c5';ctx.font='11px Arial';ctx.fillText(String(k),pad+i*(barW+4),c.height-10)})}



/* Download, reset, save */

function downloadCSV(){if(!lastCSV){alert('Run analysis first');return}const match=(dom('matchName').value||dom('teamHome').value+'_vs_'+dom('teamAway').value).replace(/\s+/g,'_');const fn=`${match}_v70_mc.csv`;const blob=new Blob([lastCSV],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=fn;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}

function resetAll(){document.querySelectorAll('input').forEach(i=>{if(i.type!=='button') i.value=''});dom('summary').textContent='Isi input lalu klik Analisis. (No demo)';dom('recs').innerHTML='';dom('trapBox').style.display='none';dom('confFill').style.width='0%';dom('confText').textContent='Confidence: 0%';const ctx=dom('hist')?.getContext?.('2d');if(ctx) ctx.clearRect(0,0,dom('hist').width,dom('hist').height);lastCSV='';dom('debug').textContent='';alert('Reset selesai')}

function saveInputs(){const data={};document.querySelectorAll('input,select').forEach(el=>{if(el.id) data[el.id]=el.value});localStorage.setItem('index_v70_inputs',JSON.stringify(data));alert('Inputs saved locally')}

function loadInputs(){try{const data=JSON.parse(localStorage.getItem('index_v70_inputs')||'{}');Object.entries(data).forEach(([id,val])=>{const el=dom(id);if(el) el.value=val})}catch(e){}}

function saveSnapshot(){try{const snap={};['teamHome','teamAway','matchName','xgHome','xgAway','mcRuns','presetMode'].forEach(k=>{const el=dom(k);if(el) snap[k]=el.value});localStorage.setItem('index_v70_snap',JSON.stringify(snap))}catch(e){}}

function presetApply(){const p=dom('presetMode').value;if(p==='league'){dom('rho').value='0.12';dom('mcRuns').value='40000'}else if(p==='cup'){dom('rho').value='0.18';dom('mcRuns').value='80000'}}



/* expose */

window.v70 = {analyzeMatch, downloadCSV, resetAll, saveInputs}

</script>

</body>

</html>

```0


