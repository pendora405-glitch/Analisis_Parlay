<!doctype html>

<html lang="id">

<head>

<meta charset="utf-8"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Prediksi v79 — Final Audit & Auto Mode</title>

<style>

:root{

  --bg:#041018; --panel:#071826; --card:#06121a; --accent:#0b74de; --muted:#9fb3c5;

  --good:#2ecc71; --warn:#ffd166; --bad:#ef476f; --txt:#dff3ff;

}

*{box-sizing:border-box}

html,body{height:100%}

body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--txt);-webkit-font-smoothing:antialiased}

.container{max-width:1100px;margin:14px auto;padding:14px}

.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}

.title{font-size:20px;color:var(--accent);margin:0}

.sub{font-size:13px;color:var(--muted)}

.panel{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}

.row{display:flex;gap:10px;flex-wrap:wrap}

.col{flex:1 1 260px;min-width:220px}

label{display:block;font-size:13px;color:var(--muted);margin-top:8px}

input,select,button,textarea{font-size:14px}

input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #22333f;background:#08131a;color:#fff}

input[readonly]{background:#0a1620;color:#9fb3c5}

button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}

button.ghost{background:transparent;border:1px solid #22333f;color:var(--txt);padding:6px 8px;border-radius:6px}

.small{font-size:12px;color:var(--muted)}

.result{background:#08141a;padding:12px;border-radius:8px;border:1px dashed #16323a;font-family:monospace;white-space:pre-wrap}

.card{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#061922;margin-bottom:8px}

.strength-bar{height:12px;border-radius:8px;background:#07202a;overflow:hidden;margin-top:6px}

.strength-fill{height:12px;border-radius:8px 0 0 8px;background:var(--accent);width:0%;transition:width .4s}

.progress-wrap{background:#07202a;border-radius:10px;padding:6px;margin-top:8px}

.progress-fill{height:18px;border-radius:8px;width:0%;transition:width .4s;background:var(--accent)}

.align-box{padding:8px;border-radius:8px;margin-top:8px}

.align-good{background:linear-gradient(90deg,#063a1f,#0f6f3f);color:#dfffe8}

.align-warn{background:linear-gradient(90deg,#3b2f06,#6f5308);color:#fff7df}

.align-bad{background:linear-gradient(90deg,#3a0a12,#6b0f1b);color:#ffdee6}

.canvas-wrap{margin-top:12px}

.footer{text-align:center;color:#6f8a94;font-size:12px;margin-top:12px}

.muted{color:var(--muted);font-size:12px}

.controls-inline{display:flex;gap:8px;align-items:center}

.btn-mode{padding:6px 10px;border-radius:6px;border:1px solid #18343f;background:transparent;color:var(--txt);cursor:pointer}

.btn-mode.active{background:var(--accent);color:#06121a}

.note{font-size:12px;color:var(--muted);margin-top:6px}

@media (max-width:1120px){.col{min-width:100%}}

</style>

</head>

<body>

  <div class="container">

    <div class="header">

      <div>

        <h1 class="title">⚽ Prediksi — v79 Final Audit & Auto Mode</h1>

        <div class="sub">Dark mode • 1 kolom • Semua tombol otomatis aktif • Bahasa Indonesia</div>

      </div>

      <div style="text-align:right">

        <div class="small">v79 — Final</div>

        <div style="margin-top:8px"><button id="btnDownloadLast" class="ghost">Unduh CSV Terakhir</button></div>

      </div>

    </div>



    <!-- Match & Mode -->

    <div class="panel">

      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">

        <div style="flex:1">

          <label>Match (Home vs Away)</label>

          <input id="matchName" placeholder="Contoh: Atalanta vs Lazio">

        </div>

        <div style="width:260px">

          <label>Kompetisi</label>

          <input id="league" placeholder="Contoh: Serie A">

        </div>

      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">

        <div class="controls-inline">

          <button id="modeLeague" class="btn-mode active">Mode League</button>

          <button id="modeCup" class="btn-mode">Mode Cup</button>

        </div>

        <div class="controls-inline" style="margin-left:auto;gap:12px">

          <div class="small">α: <span id="alphaDisplay">0.15</span></div>

          <div class="small">ρ: <span id="rhoDisplay">0.12</span></div>

          <div class="small">MC: <span id="mcDisplay">50,000</span></div>

        </div>

      </div>

    </div>



    <!-- Inputs -->

    <div class="panel">

      <h3 style="margin:0">Input — Isi semua pasangan Home & Away</h3>



      <div style="margin-top:8px" class="note">Isi field numeric dengan angka. Gunakan tombol otomatis untuk menghitung nilai yang saling terkait.</div>



      <h4 style="margin-top:12px">Tim & Proxy</h4>

      <div class="row">

        <div class="col"><label>Home Team</label><input id="teamHome" placeholder="Home"></div>

        <div class="col"><label>Away Team</label><input id="teamAway" placeholder="Away"></div>

        <div class="col"><label>Rata-rata Gol Liga (avg total goals)</label><input id="avgLeagueGoals" type="number" step="0.01" value="2.6"></div>

      </div>



      <h4 style="margin-top:12px">Attack inti</h4>

      <div class="row">

        <div class="col"><label>xG / game Home</label><input id="xgHome" type="number" step="0.01"></div>

        <div class="col"><label>xG / game Away</label><input id="xgAway" type="number" step="0.01"></div>

        <div class="col"><label>SOT Home</label><input id="sotHome" type="number" step="0.1"></div>

      </div>

      <div class="row" style="margin-top:8px">

        <div class="col"><label>SOT Away</label><input id="sotAway" type="number" step="0.1"></div>

        <div class="col"><label>Goals/game Home (fallback)</label><input id="gfHome" type="number" step="0.01"></div>

        <div class="col"><label>Goals/game Away (fallback)</label><input id="gfAway" type="number" step="0.01"></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Big Chances Home</label><input id="bigHome" type="number" step="0.1" value="0"></div>

        <div class="col"><label>Missed Big Home</label><input id="missHome" type="number" step="0.1" value="0"></div>

        <div class="col"><label>Conversion Rate Home (dec) atau kosong</label><input id="convHome" type="number" step="0.01"></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Big Chances Away</label><input id="bigAway" type="number" step="0.1" value="0"></div>

        <div class="col"><label>Missed Big Away</label><input id="missAway" type="number" step="0.1" value="0"></div>

        <div class="col"><label>Conversion Rate Away (dec) atau kosong</label><input id="convAway" type="number" step="0.01"></div>

      </div>



      <div style="margin-top:8px">

        <button id="btnBigIdx" class="ghost">Hitung Big Chance Index</button>

        <button id="btnCR" class="ghost">Hitung Conversion Rate (CR)</button>

      </div>



      <h4 style="margin-top:12px">Defense inti</h4>

      <div class="row">

        <div class="col"><label>Tackles Home</label><input id="tackleHome" type="number" step="0.1"></div>

        <div class="col"><label>Interceptions Home</label><input id="interHome" type="number" step="0.1"></div>

        <div class="col"><label>TI Home (auto)</label><input id="tiHome" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Tackles Away</label><input id="tackleAway" type="number" step="0.1"></div>

        <div class="col"><label>Interceptions Away</label><input id="interAway" type="number" step="0.1"></div>

        <div class="col"><label>TI Away (auto)</label><input id="tiAway" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Clean sheets Home (count)</label><input id="csCountHome" type="number"></div>

        <div class="col"><label>Match CS Home</label><input id="csMatchesHome" type="number"></div>

        <div class="col"><label>CSR Home (auto)</label><input id="csHome" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Clean sheets Away (count)</label><input id="csCountAway" type="number"></div>

        <div class="col"><label>Match CS Away</label><input id="csMatchesAway" type="number"></div>

        <div class="col"><label>CSR Away (auto)</label><input id="csAway" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Goals conceded Home (total)</label><input id="gcHomeCount" type="number"></div>

        <div class="col"><label>Matches GA Home</label><input id="gcMatchesHome" type="number"></div>

        <div class="col"><label>GA/game Home (auto)</label><input id="gcHome" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Goals conceded Away (total)</label><input id="gcAwayCount" type="number"></div>

        <div class="col"><label>Matches GA Away</label><input id="gcMatchesAway" type="number"></div>

        <div class="col"><label>GA/game Away (auto)</label><input id="gcAway" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Saves Home (total)</label><input id="saveHomeTotal" type="number"></div>

        <div class="col"><label>Matches Save Home</label><input id="saveMatchesHome" type="number"></div>

        <div class="col"><label>Saves/game Home (auto)</label><input id="saveHome" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Saves Away (total)</label><input id="saveAwayTotal" type="number"></div>

        <div class="col"><label>Matches Save Away</label><input id="saveMatchesAway" type="number"></div>

        <div class="col"><label>Saves/game Away (auto)</label><input id="saveAway" readonly></div>

      </div>



      <div style="margin-top:8px">

        <button id="btnTI" class="ghost">Hitung TI</button>

        <button id="btnCSR" class="ghost">Hitung CSR & GA & SAVE</button>

        <button id="btnERR" class="ghost">Hitung Error Ratio (ERR)</button>

      </div>



      <h4 style="margin-top:12px">Form, H2H & Absensi</h4>

      <div class="row">

        <div class="col"><label>Form Home (W,D,L comma)</label><input id="formRawHome" placeholder="W,W,D,W,L"></div>

        <div class="col"><label>Form Away</label><input id="formRawAway" placeholder="W,L,D,W,D"></div>

        <div class="col"><label>H2H recent (W/D/L for Home)</label><input id="h2hRaw" placeholder="W,D,L"></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Form Home index (auto)</label><input id="formHome" readonly></div>

        <div class="col"><label>Form Away index (auto)</label><input id="formAway" readonly></div>

        <div class="col"><label>H2H Win Rate (auto)</label><input id="h2hRate" readonly></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>Absent DF,MF,FW Home (comma)</label><input id="absHome" placeholder="0,0,0"></div>

        <div class="col"><label>Absent DF,MF,FW Away</label><input id="absAway" placeholder="0,0,0"></div>

        <div class="col"><label>Errors → goal Home (est per season)</label><input id="errHome" type="number" value="7"></div>

      </div>



      <div style="margin-top:6px">

        <label class="small">Errors → goal Away (est per season)</label>

        <input id="errAway" type="number" value="8">

      </div>



      <div style="margin-top:8px">

        <button id="btnAutoForm" class="ghost">Auto Form & H2H</button>

      </div>



      <h4 style="margin-top:12px">Odds — Open & Now</h4>

      <div class="row">

        <div class="col"><label>HDP Line (eg: 0.25)</label><input id="hdpLine" type="number" step="0.25" value="0.25"></div>

        <div class="col"><label>HDP Home Open (odds decimal)</label><input id="hdpHomeOpen" type="number" step="0.01"></div>

        <div class="col"><label>HDP Home Now</label><input id="hdpHomeNow" type="number" step="0.01"></div>

      </div>

      <div class="row" style="margin-top:8px">

        <div class="col"><label>HDP Away Open</label><input id="hdpAwayOpen" type="number" step="0.01"></div>

        <div class="col"><label>HDP Away Now</label><input id="hdpAwayNow" type="number" step="0.01"></div>

        <div class="col"><label>Odds Δ% Threshold (trap)</label><input id="trapThreshold" type="number" step="0.1" value="5"></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>OU Line</label><input id="ouLine" type="number" step="0.25" value="2.5"></div>

        <div class="col"><label>OU Over Open</label><input id="ouOverOpen" type="number" step="0.01"></div>

        <div class="col"><label>OU Over Now</label><input id="ouOverNow" type="number" step="0.01"></div>

      </div>



      <div class="row" style="margin-top:8px">

        <div class="col"><label>OU Under Open</label><input id="ouUnderOpen" type="number" step="0.01"></div>

        <div class="col"><label>OU Under Now</label><input id="ouUnderNow" type="number" step="0.01"></div>

        <div class="col"><label>Odds Source</label><input id="oddsSource" placeholder="Pinnacle, Betfair..."></div>

      </div>



      <h4 style="margin-top:12px">Parameter MC & Fine-tune</h4>

      <div class="row">

        <div class="col"><label>Alpha (shrink) — override (auto by mode if left)</label><input id="alphaInput" type="number" step="0.01"></div>

        <div class="col"><label>Rho (correlation)</label><input id="rhoInput" type="number" step="0.01"></div>

        <div class="col"><label>MC Runs</label><input id="mcInput" type="number"></div>

      </div>



      <div style="margin-top:10px;text-align:center">

        <button id="btnAnalyze">Analisis (MC)</button>

        <button id="btnReset" class="ghost">Reset</button>

      </div>



    </div>



    <!-- Results below -->

    <div id="resultsArea" class="panel">

      <h3 style="margin:0">Hasil Analisis (Output)</h3>

      <div id="summary" class="result" style="margin-top:8px">Isi input lalu klik <b>Analisis</b>.</div>



      <div style="margin-top:12px">

        <div><b>Attack Home</b> <span id="atkHomeVal" style="float:right">-</span></div>

        <div class="strength-bar"><div id="atkHomeBar" class="strength-fill"></div></div>



        <div style="margin-top:8px"><b>Defense Home</b> <span id="defHomeVal" style="float:right">-</span></div>

        <div class="strength-bar"><div id="defHomeBar" class="strength-fill"></div></div>



        <div style="height:8px"></div>



        <div style="margin-top:8px"><b>Attack Away</b> <span id="atkAwayVal" style="float:right">-</span></div>

        <div class="strength-bar"><div id="atkAwayBar" class="strength-fill"></div></div>



        <div style="margin-top:8px"><b>Defense Away</b> <span id="defAwayVal" style="float:right">-</span></div>

        <div class="strength-bar"><div id="defAwayBar" class="strength-fill"></div></div>

      </div>



      <div style="margin-top:12px">

        <label class="small">Confidence</label>

        <div class="progress-wrap"><div id="confFill" class="progress-fill" style="width:0%"></div></div>

        <div id="confText" class="small" style="text-align:right">Confidence: 0%</div>

      </div>



      <div id="marketAlign" class="align-box" style="display:none;margin-top:8px"></div>

      <div id="marketExplain" class="muted" style="margin-top:8px;opacity:0.95"></div>



      <div id="recs" style="margin-top:12px"></div>

      <div id="recommendation" class="result" style="margin-top:12px;background:#07121b"></div>



      <div class="canvas-wrap" style="margin-top:12px">

        <canvas id="hist" width="960" height="200" style="background:#041620;border-radius:6px;display:block;width:100%"></canvas>

        <div style="height:8px"></div>

        <canvas id="gauge" width="960" height="80" style="background:#041620;border-radius:6px;display:block;width:100%"></canvas>

      </div>



      <div id="trapInfo" class="result" style="margin-top:12px;background:#07121b;display:none"></div>

      <div id="debug" class="result" style="margin-top:8px;background:#06111a"></div>

    </div>



    <div class="footer">v79 Final — Salin file & buka di browser. Hasil dari input manual. Mode League/Cup aktif.</div>

  </div>



<script>

/* -------------------------

   v79 Final JS

   ------------------------- */



/* Utilities */

const $ = id => document.getElementById(id);

function safeVal(v,d=NaN){ const x=parseFloat(v); return isNaN(x)?d:x; }

function clamp(v,a,b){ if(isNaN(v)) return a; return Math.max(a,Math.min(b,v)); }

function pct(v){ return isNaN(v)?'-':(100*v).toFixed(1)+'%'; }

function nowISO(){ return (new Date()).toISOString().replace(/[:.]/g,'-'); }

let lastCSV = '';



/* Poisson and sampling */

function poissonRand(lambda){

  if(!isFinite(lambda) || lambda<=0) return 0;

  let L = Math.exp(-lambda), p=1, k=0;

  while(p > L){ k++; p *= Math.random(); if(k>10000) break; }

  return k-1;

}

function sampleBivariate(lambdaH, lambdaA, rho){

  const shared = Math.max(0, rho * Math.min(lambdaH, lambdaA));

  const hPart = Math.max(0, lambdaH - shared);

  const aPart = Math.max(0, lambdaA - shared);

  const sh = poissonRand(shared);

  return [sh + poissonRand(hPart), sh + poissonRand(aPart)];

}



/* Parse helpers */

function parseAbsent(s){

  if(!s) return [0,0,0];

  const a = s.toString().split(',').map(x=>safeVal(x.trim(),0));

  return [a[0]||0,a[1]||0,a[2]||0];

}

function formScore(raw){

  if(!raw) return 0.5;

  const parts = raw.toString().toUpperCase().replace(/[^WDL, ]/g,'').split(/[ ,]+/).filter(Boolean).slice(0,5);

  if(parts.length===0) return 0.5;

  let score=0, total=0;

  parts.forEach((p,i)=>{

    const w = 1 - i*0.08; total += w;

    if(p==='W') score += 1*w; else if(p==='D') score += 0.5*w;

  });

  return score/total;

}

function h2hWinRate(raw){

  if(!raw) return 0.5;

  const parts = raw.toString().toUpperCase().replace(/[^WDL, ]/g,'').split(/[ ,]+/).filter(Boolean).slice(0,10);

  if(parts.length===0) return 0.5;

  const w = parts.filter(p=>p==='W').length;

  return w / parts.length;

}



/* Auto calculations (paired) */

function computeTI(){

  const tH = safeVal($('tackleHome').value,0), iH = safeVal($('interHome').value,0);

  const tA = safeVal($('tackleAway').value,0), iA = safeVal($('interAway').value,0);

  $('tiHome').value = (tH + iH).toFixed(1);

  $('tiAway').value = (tA + iA).toFixed(1);

  showTempMsg('TI dihitung otomatis (Home & Away).');

}

function computeCSR_GA_SAVE(){

  // CSR

  const csH = safeVal($('csCountHome').value,NaN), csMH = safeVal($('csMatchesHome').value,NaN);

  if(csMH>0) $('csHome').value = clamp(csH/csMH,0,1).toFixed(2);

  const csA = safeVal($('csCountAway').value,NaN), csMA = safeVal($('csMatchesAway').value,NaN);

  if(csMA>0) $('csAway').value = clamp(csA/csMA,0,1).toFixed(2);

  // GA

  const gaH = safeVal($('gcHomeCount').value,NaN), gaMH = safeVal($('gcMatchesHome').value,NaN);

  if(gaMH>0) $('gcHome').value = (gaH/gaMH).toFixed(2);

  const gaA = safeVal($('gcAwayCount').value,NaN), gaMA = safeVal($('gcMatchesAway').value,NaN);

  if(gaMA>0) $('gcAway').value = (gaA/gaMA).toFixed(2);

  // SAVE

  const svH = safeVal($('saveHomeTotal').value,NaN), svMH = safeVal($('saveMatchesHome').value,NaN);

  if(svMH>0) $('saveHome').value = (svH/svMH).toFixed(2);

  const svA = safeVal($('saveAwayTotal').value,NaN), svMA = safeVal($('saveMatchesAway').value,NaN);

  if(svMA>0) $('saveAway').value = (svA/svMA).toFixed(2);

  showTempMsg('CSR / GA / SAVE dihitung otomatis.');

}

function computeCR(){

  // CR = goals / SOT

  const gH = safeVal($('gfHome').value,NaN), sH = safeVal($('sotHome').value,NaN);

  if(sH>0) $('convHome').value = (gH/sH).toFixed(2);

  const gA = safeVal($('gfAway').value,NaN), sA = safeVal($('sotAway').value,NaN);

  if(sA>0) $('convAway').value = (gA/sA).toFixed(2);

  showTempMsg('Conversion Rate (CR) dihitung otomatis.');

}

function computeBigIdx(){

  const bh = safeVal($('bigHome').value,0), mh = safeVal($('missHome').value,0);

  const ba = safeVal($('bigAway').value,0), ma = safeVal($('missAway').value,0);

  $('bigHome').value = bh; $('bigAway').value = ba; // keep as entered

  showTempMsg('Big Chance index (paired) telah dicatat.');

}

function computeFormH2H(){

  $('formHome').value = formScore($('formRawHome').value).toFixed(2);

  $('formAway').value = formScore($('formRawAway').value).toFixed(2);

  $('h2hRate').value = h2hWinRate($('h2hRaw').value).toFixed(2);

  showTempMsg('Form & H2H dihitung otomatis.');

}



/* Visual helper */

function showTempMsg(msg){

  const prev = $('debug'); if(prev) prev.textContent = msg;

  setTimeout(()=>{ /* clear after 3s if unchanged */ },3000);

}



/* Attack & Defense index improved */

function attackIndex(team){

  // team: {xg,gf,sot,conv,big,miss,form,poss}

  const xg = team.xg || (team.gf || 1.0);

  const sotFactor = 0.22 * ((team.sot||3)/5);

  const convFactor = team.conv ? 0.13 * (team.conv*100) : 0;

  const formFactor = 0.15 * (team.form||0.5);

  const bigMiss = ((team.big||0) - (team.miss||0));

  const bigFactor = clamp(bigMiss * 0.035, -0.15, 0.3);

  const base = 0.48 * xg + sotFactor + convFactor + formFactor;

  const adj = 1 + bigFactor + clamp(((team.poss||50)-50)*0.004, -0.12, 0.12);

  return clamp(base * adj, 0.1, 5.5);

}

function defenseIndex(team){

  // team: {cs,ga,ti,err,saves,absDf}

  const cs = clamp(team.cs||0,0,1);

  const ga = Math.max(0.01, team.ga || 1.2);

  const ti = clamp(team.ti||0,0,120);

  const err = clamp(team.err||7,0,50);

  const saves = team.saves || 0;

  const csAdj = 1 - (0.30 * cs);

  const gaAdj = 1 + (0.20 * ga);

  const tiAdj = 1 - clamp(ti/70, 0, 0.32);

  const absAdj = 1 + clamp((team.absDf||0)*0.05, 0, 0.4);

  const errAdj = 1 + (err/38)*0.035;

  const saveAdj = 1 - Math.log(1+saves)/Math.log(1+8)*0.09;

  return clamp(csAdj * gaAdj * tiAdj * absAdj * errAdj * saveAdj, 0.4, 4.5);

}



/* balance lambda to league average and shrink */

function balanceLambda(lambdaH, lambdaA, leagueAvg){

  let avg = (lambdaH + lambdaA)/2;

  if(avg > 3.2){ lambdaH *= 0.86; lambdaA *= 0.86; }

  else if(avg > 2.2){ lambdaH *= 0.94; lambdaA *= 0.94; }

  const base = (leagueAvg || 2.6) / 2.6;

  lambdaH *= base; lambdaA *= base;

  return [lambdaH, lambdaA];

}



/* Monte Carlo engine */

function monteCarlo(lambdaH, lambdaA, rho, runs){

  const scoreFreq = {}, totals = {};

  let homeW=0,draw=0,awayW=0;

  for(let i=0;i<runs;i++){

    const [gh,ga] = sampleBivariate(lambdaH, lambdaA, rho);

    const k = `${gh}-${ga}`;

    scoreFreq[k] = (scoreFreq[k]||0) + 1;

    totals[gh+ga] = (totals[gh+ga]||0) + 1;

    if(gh>ga) homeW++; else if(gh===ga) draw++; else awayW++;

  }

  return {scoreFreq, totals, pHome:homeW/runs, pDraw:draw/runs, pAway:awayW/runs};

}



/* probabilities helpers */

function probOUFromTotals(totals,line,runs){

  let over=0, under=0;

  const isInt = Number.isInteger(line);

  for(const t in totals){

    const g=parseInt(t), v=totals[t];

    if(isInt){

      if(g>line) over+=v; else if(g<line) under+=v; else {over+=0.5*v; under+=0.5*v;}

    } else {

      if(g>line) over+=v; else under+=v;

    }

  }

  return {over: over/runs, under: under/runs};

}

function probCoverFromScores(scoreFreq, handicap, runs){

  let win=0,push=0,lose=0;

  for(const sc in scoreFreq){

    const v = scoreFreq[sc];

    const [gh,ga] = sc.split('-').map(x=>parseInt(x));

    const diff = gh - ga - handicap;

    if(diff>0) win += v; else if(diff===0) push += v; else lose += v;

  }

  return (win + 0.5*push)/runs;

}



/* rendering histogram & gauge */

function renderHistogram(totals, canvasId='hist'){

  const c = $(canvasId); if(!c) return;

  const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);

  const keys = Object.keys(totals).map(x=>parseInt(x)).sort((a,b)=>a-b);

  if(keys.length===0) return;

  const maxV = Math.max(...Object.values(totals));

  const pad = 40;

  const barW = Math.max(6, (c.width - pad*2) / keys.length - 4);

  keys.forEach((k,i)=>{

    const v = totals[k] || 0;

    const h = (v / maxV) * (c.height - 50);

    ctx.fillStyle = '#0b74de';

    ctx.fillRect(pad + i*(barW+4), c.height - 30 - h, barW, h);

    ctx.fillStyle = '#9fb3c5';

    ctx.font = '11px Arial';

    ctx.fillText(String(k), pad + i*(barW+4), c.height - 8);

  });

}

function renderGauge(percentVal, canvasId='gauge'){

  const c = $(canvasId); if(!c) return;

  const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);

  const w = c.width, h = c.height;

  ctx.lineWidth = 14;

  ctx.strokeStyle = '#07202a';

  ctx.beginPath();

  ctx.arc(w/2, h, Math.min(w/2-20,h-10), Math.PI, 0);

  ctx.stroke();

  const angle = Math.PI * (percentVal/100);

  const grad = ctx.createLinearGradient(0,0,w,0);

  grad.addColorStop(0, '#ef476f'); grad.addColorStop(0.5, '#ffd166'); grad.addColorStop(1, '#2ecc71');

  ctx.strokeStyle = grad;

  ctx.beginPath();

  ctx.arc(w/2, h, Math.min(w/2-20,h-10), Math.PI, Math.PI - angle);

  ctx.stroke();

  ctx.fillStyle = '#dff3ff'; ctx.font = '16px Arial'; ctx.textAlign = 'center';

  ctx.fillText('Confidence: ' + percentVal.toFixed(0) + '%', w/2, h-20);

}



/* build recommendation text (Indonesian) */

function buildRecommendation(data){

  const lines = [];

  lines.push(`🔎 Rekomendasi — ${data.home} vs ${data.away}`);

  lines.push('');

  if(data.pHome >= 0.58) lines.push(`• Model merekomendasikan kemenangan tuan rumah: ${pct(data.pHome)}.`);

  else if(data.pAway >= 0.58) lines.push(`• Model merekomendasikan kemenangan tim tamu: ${pct(data.pAway)}.`);

  else if(data.pDraw >= 0.35) lines.push(`• Peluang imbang cukup besar: ${pct(data.pDraw)}.`);

  else lines.push(`• Tidak ada pemenang jelas: Home ${pct(data.pHome)} • Draw ${pct(data.pDraw)} • Away ${pct(data.pAway)}.`);



  if(data.ouProb.over >= 0.60) lines.push(`• Over ${$('ouLine').value} kuat (${pct(data.ouProb.over)}).`);

  else if(data.ouProb.under >= 0.60) lines.push(`• Under ${$('ouLine').value} kuat (${pct(data.ouProb.under)}).`);

  else lines.push(`• Over/Under relatif seimbang: Over ${pct(data.ouProb.over)} • Under ${pct(data.ouProb.under)}.`);



  if(data.valueLabel === 'VALUE') lines.push(`• POTENSI VALUE berdasarkan model vs market — cek odds & lineup.`);

  else lines.push(`• Tidak ditemukan edge pasar yang kuat untuk value bet.`);



  lines.push('');

  lines.push(`🔢 Confidence model: ${data.confPct}% (${data.confPct >= 65? 'Tinggi' : (data.confPct>=50? 'Sedang':'Rendah')}).`);

  lines.push('');

  lines.push('⚠️ Catatan: verifikasi lineup & kondisi pemain inti sebelum bertaruh.');

  return lines.join('\n');

}



/* detect traps (odds delta) */

function detectTraps(imp){

  const threshold = clamp(safeVal($('trapThreshold').value,5), 1, 200);

  const diffs = [];

  if(imp.ouOverNow && imp.ouOverOpen) diffs.push({market:'OU Over', delta: (imp.ouOverNow - imp.ouOverOpen)*100});

  if(imp.ouUnderNow && imp.ouUnderOpen) diffs.push({market:'OU Under', delta: (imp.ouUnderNow - imp.ouUnderOpen)*100});

  if(imp.hdpHomeNow && imp.hdpHomeOpen) diffs.push({market:'HDP Home', delta: (imp.hdpHomeNow - imp.hdpHomeOpen)*100});

  if(imp.hdpAwayNow && imp.hdpAwayOpen) diffs.push({market:'HDP Away', delta: (imp.hdpAwayNow - imp.hdpAwayOpen)*100});

  let html = '', trap=false;

  diffs.forEach(d=>{ html += `${d.market} Δ%: ${d.delta.toFixed(2)}%\n`; if(Math.abs(d.delta) >= threshold) trap=true; });

  if(trap){ $('trapInfo').style.display='block'; $('trapInfo').textContent='⚠️ Odds Trap terdeteksi:\n'+html; } else { $('trapInfo').style.display='none'; $('trapInfo').textContent=''; }

}



/* Render recommendations cards */

function renderRecommendations(list, combinedIdx){

  $('recs').innerHTML = '';

  list.sort((a,b)=>{

    const sa = (a.prob||0)*0.7 + (a.edge||0)*0.3;

    const sb = (b.prob||0)*0.7 + (b.edge||0)*0.3;

    return sb - sa;

  }).slice(0,3).forEach(it=>{

    const div = document.createElement('div'); div.className = 'card';

    const edgeStr = (it.edge===null)? 'No market' : ('edge ' + (it.edge*100).toFixed(2) + '%');

    const sig = (it.edge!==null && Math.abs(it.edge) > 0.015 && it.prob>=0.55) ? 'BET' : 'HOLD';

    div.innerHTML = `<div style="font-weight:700">${it.tag}</div><div style="text-align:right">${pct(it.prob)}<div class="small">${edgeStr}</div><div class="small">${sig}</div></div>`;

    $('recs').appendChild(div);

  });

}



/* CSV download */

function downloadLastCSV(){

  if(!lastCSV){ alert('Jalankan Analisis dulu'); return; }

  const filename = ( ($('matchName').value || ($('teamHome').value + '_vs_' + $('teamAway').value)) .replace(/\s+/g,'_') ) + '_v79_' + nowISO() + '.csv';

  const blob = new Blob([lastCSV], {type:'text/csv'}); const url = URL.createObjectURL(blob);

  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();

  URL.revokeObjectURL(url);

}



/* Main analyze function */

function analyze(){

  try{

    const home = ($('teamHome').value||'').trim();

    const away = ($('teamAway').value||'').trim();

    if(!home || !away){ alert('Isi Home dan Away terlebih dahulu'); return; }



    // collect inputs (paired)

    const xgH = safeVal($('xgHome').value, NaN), xgA = safeVal($('xgAway').value, NaN);

    const sotH = safeVal($('sotHome').value, NaN), sotA = safeVal($('sotAway').value, NaN);

    const gfH = safeVal($('gfHome').value, NaN), gfA = safeVal($('gfAway').value, NaN);

    const convH = safeVal($('convHome').value, NaN), convA = safeVal($('convAway').value, NaN);

    const bigH = safeVal($('bigHome').value,0), missH = safeVal($('missHome').value,0);

    const bigA = safeVal($('bigAway').value,0), missA = safeVal($('missAway').value,0);



    const tiH = safeVal($('tiHome').value, NaN), tiA = safeVal($('tiAway').value, NaN);

    const csH = safeVal($('csHome').value,NaN), csA = safeVal($('csAway').value,NaN);

    const gaH = safeVal($('gcHome').value,1.2), gaA = safeVal($('gcAway').value,1.2);

    const saveH = safeVal($('saveHome').value,0), saveA = safeVal($('saveAway').value,0);

    const errH = safeVal($('errHome').value,7), errA = safeVal($('errAway').value,8);

    const absH = parseAbsent($('absHome').value), absA = parseAbsent($('absAway').value);

    const formH = clamp(safeVal($('formHome').value, NaN), 0, 1);

    const formA = clamp(safeVal($('formAway').value, NaN), 0, 1);

    const h2hRate = clamp(safeVal($('h2hRate').value, NaN), 0, 1);



    const eloH = safeVal($('eloHome')? $('eloHome').value : null,1500);

    const eloA = safeVal($('eloAway')? $('eloAway').value : null,1500);



    // odds implied

    function implied(od){ return od && od>0 ? 1/od : null; }

    const imp = {

      hdpHomeOpen: implied(safeVal($('hdpHomeOpen').value,NaN)),

      hdpHomeNow: implied(safeVal($('hdpHomeNow').value,NaN)),

      hdpAwayOpen: implied(safeVal($('hdpAwayOpen').value,NaN)),

      hdpAwayNow: implied(safeVal($('hdpAwayNow').value,NaN)),

      ouOverOpen: implied(safeVal($('ouOverOpen').value,NaN)),

      ouOverNow: implied(safeVal($('ouOverNow').value,NaN)),

      ouUnderOpen: implied(safeVal($('ouUnderOpen').value,NaN)),

      ouUnderNow: implied(safeVal($('ouUnderNow').value,NaN))

    };



    // lines

    const ouLine = safeVal($('ouLine').value,2.5);

    const hdpLine = safeVal($('hdpLine').value,0.25);



    // parameters: mode override or inputs

    const alphaInput = safeVal($('alphaInput').value, NaN);

    const rhoInput = safeVal($('rhoInput').value, NaN);

    const mcInput = Math.round(clamp(safeVal($('mcInput').value,NaN),2000,120000));



    // default mode values

    let alpha = isNaN(alphaInput) ? 0.15 : clamp(alphaInput, 0.02, 0.30);

    let rho = isNaN(rhoInput) ? 0.12 : clamp(rhoInput, 0.01, 0.45);

    let mcRuns = isNaN(mcInput) ? 50000 : mcInput;



    // adjust alpha slightly to reduce bias: use xg difference and form difference

    const baseXGH = xgH || gfH || 1.0;

    const baseXGA = xgA || gfA || 1.0;

    const xgDiff = Math.abs(baseXGH - baseXGA);

    const formDiff = Math.abs( (isNaN(formH)?0.5:formH) - (isNaN(formA)?0.5:formA) );

    alpha = clamp(alpha + 0.015*xgDiff + 0.01*formDiff, 0.03, 0.22);



    // compute indices

    const atkH = attackIndex({xg: baseXGH, gf:gfH, sot:sotH, conv:convH, big:bigH, miss:missH, form:isNaN(formH)?0.5:formH});

    const atkA = attackIndex({xg: baseXGA, gf:gfA, sot:sotA, conv:convA, big:bigA, miss:missA, form:isNaN(formA)?0.5:formA});

    const defH = defenseIndex({cs: csH, ga: gaH, ti: tiH, err: errH, saves: saveH, absDf: absH[0]});

    const defA = defenseIndex({cs: csA, ga: gaA, ti: tiA, err: errA, saves: saveA, absDf: absA[0]});



    // baseXG proxy

    const baseXG = Math.max(0.35, (baseXGH + baseXGA)/2);

    let lambdaH = baseXG * (atkH / Math.max(0.3, baseXG)) * (1/defA);

    let lambdaA = baseXG * (atkA / Math.max(0.3, baseXG)) * (1/defH);



    // blend with rating proxies (alpha shrink)

    const ratingProxyH = baseXGH;

    const ratingProxyA = baseXGA;

    lambdaH = alpha*ratingProxyH + (1-alpha)*lambdaH;

    lambdaA = alpha*ratingProxyA + (1-alpha)*lambdaA;



    // form & h2h influence

    const h2hImpact = clamp((h2hRate - 0.5) * 0.22, -0.12, 0.12);

    const recFormImpact = clamp(( (isNaN(formH)?0.5:formH) - (isNaN(formA)?0.5:formA) ) * 0.20, -0.12, 0.12);

    lambdaH *= (1 + 0.6*recFormImpact + 0.4*h2hImpact);

    lambdaA *= (1 - 0.6*recFormImpact - 0.4*h2hImpact);



    // elo coarse factor

    const eloDiff = (eloH - eloA);

    const eloFactorH = 1 + clamp(eloDiff/4000, -0.18, 0.18);

    const eloFactorA = 1 - clamp(eloDiff/4000, -0.18, 0.18);

    lambdaH *= eloFactorH; lambdaA *= eloFactorA;



    // absence penalty (paired)

    const penaltyH = 1 - clamp((absH[0]*0.04 + absH[1]*0.03 + absH[2]*0.05), 0, 0.25);

    const penaltyA = 1 - clamp((absA[0]*0.04 + absA[1]*0.03 + absA[2]*0.05), 0, 0.25);

    lambdaH *= penaltyH; lambdaA *= penaltyA;



    // balance

    const leagueAvg = safeVal($('avgLeagueGoals').value,2.6);

    [lambdaH, lambdaA] = balanceLambda(lambdaH, lambdaA, leagueAvg);



    // run MC (cap runs to avoid freezing, use web worker? but now cap at 100k)

    if(mcRuns > 100000) mcRuns = 100000;

    const mc = monteCarlo(lambdaH, lambdaA, rho, mcRuns);

const pH = mc.pHome, pD = mc.pDraw, pA = mc.pAway;

    const avgH = Object.entries(mc.scoreFreq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[0])*v,0) / mcRuns;

    const avgA = Object.entries(mc.scoreFreq).reduce((s,[sc,v])=>s + parseInt(sc.split('-')[1])*v,0) / mcRuns;



    // OU & HDP probabilities

    const ouProb = probOUFromTotals(mc.totals, ouLine, mcRuns);

    const coverHome = probCoverFromScores(mc.scoreFreq, hdpLine, mcRuns);

    const coverAway = 1 - coverHome;



    // implied edges

    const e = {

      hdpHome: imp.hdpHomeNow? (coverHome - imp.hdpHomeNow) : null,

      hdpAway: imp.hdpAwayNow? (coverAway - imp.hdpAwayNow) : null,

      ouOver: imp.ouOverNow? (ouProb.over - imp.ouOverNow) : null,

      ouUnder: imp.ouUnderNow? (ouProb.under - imp.ouUnderNow) : null

    };



    const avgEdgeHDP = ((e.hdpHome||0) + (e.hdpAway||0)) / 2;

    const avgEdgeOU = ((e.ouOver||0) + (e.ouUnder||0)) / 2;

    const combinedIndex = 0.6 * avgEdgeHDP + 0.4 * avgEdgeOU;



    let valueLabel = 'HOLD';

    if(isFinite(combinedIndex) && Math.abs(combinedIndex) > 0.015 && Math.max(pH,pA,ouProb.over,ouProb.under) >= 0.55){

      valueLabel = combinedIndex > 0 ? 'VALUE' : 'NO VALUE';

    }



    const topProb = Math.max(pH,pA,ouProb.over,ouProb.under);

    const confPct = Math.round(topProb * 100);



    // update UI

    $('alphaDisplay').textContent = alpha.toFixed(2);

    $('rhoDisplay').textContent = rho.toFixed(2);

    $('mcDisplay').textContent = mcRuns.toLocaleString();



    $('confFill').style.width = confPct + '%';

    $('confFill').style.background = confPct < 45 ? '#ef476f' : (confPct < 65 ? '#ffd166' : '#2ecc71');

    $('confText').textContent = 'Confidence: ' + confPct + '%';

    renderGauge(confPct, 'gauge');



    // summary

    const summary = [

      `Match: ${home} vs ${away}`,

      `λ (sharp): Home ${lambdaH.toFixed(2)} | Away ${lambdaA.toFixed(2)}`,

      `Attack idx H:${atkH.toFixed(2)} A:${atkA.toFixed(2)} | Def H:${defH.toFixed(2)} A:${defA.toFixed(2)}`,

      `Exp goals (sim): H ${avgH.toFixed(2)} | A ${avgA.toFixed(2)}`,

      `Prob 1X2 — Home ${pct(pH)} Draw ${pct(pD)} Away ${pct(pA)}`,

      `OU(${ouLine}) → Over ${pct(ouProb.over)} | Under ${pct(ouProb.under)}`,

      `HDP(${hdpLine}) → Home ${pct(coverHome)} | Away ${pct(coverAway)}`,

      `Alpha:${alpha.toFixed(2)} | Rho:${rho.toFixed(2)} | Runs:${mcRuns}`,

      `Combined Index: ${(combinedIndex*100).toFixed(2)}% → ${valueLabel}`,

      `Absent H:${absH.join('/')} A:${absA.join('/')} • TI H:${tiH} A:${tiA}`,

      `Confidence: ${confPct}%`

    ];

    $('summary').textContent = summary.join('\n');



    updateStrengthBar('atkHomeBar','atkHomeVal', atkH);

    updateStrengthBar('defHomeBar','defHomeVal', 1/defH*6);

    updateStrengthBar('atkAwayBar','atkAwayVal', atkA);

    updateStrengthBar('defAwayBar','defAwayVal', 1/defA*6);



    // recs

    const candidates = [

      {tag:`HDP Home ${hdpLine}`, prob: coverHome, edge: e.hdpHome, market:'HDP'},

      {tag:`HDP Away ${-hdpLine}`, prob: coverAway, edge: e.hdpAway, market:'HDP'},

      {tag:`OU Over ${ouLine}`, prob: ouProb.over, edge: e.ouOver, market:'OU'},

      {tag:`OU Under ${ouLine}`, prob: ouProb.under, edge: e.ouUnder, market:'OU'}

    ];

    renderRecommendations(candidates, combinedIndex);



    detectTraps(imp);



    const recText = buildRecommendation({

      home, away, pHome:pH, pDraw:pD, pAway:pA, ouProb, coverHome, coverAway, imp, e, combinedIndex, confPct, valueLabel

    });

    $('recommendation').textContent = recText;



    renderHistogram(mc.totals, 'hist');



    // CSV prepare

    let csv = 'score,count,prob\n';

    Object.keys(mc.scoreFreq).sort((a,b)=>mc.scoreFreq[b]-mc.scoreFreq[a]).forEach(k=>{

      const c = mc.scoreFreq[k];

      csv += `${k},${c},${(c/mcRuns).toFixed(6)}\n`;

    });

    lastCSV = csv;

    $('debug').textContent = `Runs:${mcRuns} • alpha:${alpha.toFixed(2)} • rho:${rho.toFixed(2)} • combinedIdx:${(combinedIndex*100).toFixed(2)}%`;



  }catch(err){

    console.error(err);

    alert('Terjadi error saat analisis, cek console.');

  }

}



/* UI helpers */

function updateStrengthBar(barId,valId,score){

  const pctv = Math.max(3, Math.min(95, (score/3.5) * 100 ));

  const bar = $(barId); if(bar) bar.style.width = pctv + '%';

  const val = $(valId); if(val) val.textContent = isNaN(score)?'-':score.toFixed(2);

}



/* Reset */

function resetAll(){

  document.querySelectorAll('input').forEach(inp=>{

    if(inp.id==='avgLeagueGoals') return; // keep league avg

    if(inp.type!=='button') inp.value='';

  });

  $('summary').textContent = 'Direset. Isi input lalu klik Analisis.';

  $('recs').innerHTML = ''; $('recommendation').textContent = ''; $('debug').textContent = '';

  $('confFill').style.width='0%'; $('confText').textContent='Confidence: 0%';

  const ctx = $('hist').getContext('2d'); ctx.clearRect(0,0,$('hist').width,$('hist').height);

  const g = $('gauge').getContext('2d'); g.clearRect(0,0,$('gauge').width,$('gauge').height);

  lastCSV = '';

}



/* Mode toggles */

function setModeLeague(){

  $('modeLeague').classList.add('active'); $('modeCup').classList.remove('active');

  $('alphaInput').value='0.15'; $('rhoInput').value='0.12'; $('mcInput').value='50000';

  $('alphaDisplay').textContent='0.15'; $('rhoDisplay').textContent='0.12'; $('mcDisplay').textContent='50,000';

}

function setModeCup(){

  $('modeCup').classList.add('active'); $('modeLeague').classList.remove('active');

  $('alphaInput').value='0.24'; $('rhoInput').value='0.20'; $('mcInput').value='80000';

  $('alphaDisplay').textContent='0.24'; $('rhoDisplay').textContent='0.20'; $('mcDisplay').textContent='80,000';

}



/* Wiring events */

window.addEventListener('load', ()=>{

  $('btnAnalyze').addEventListener('click', analyze);

  $('btnReset').addEventListener('click', resetAll);

  $('btnDownloadLast').addEventListener('click', downloadLastCSV);



  $('btnTI').addEventListener('click', ()=>{ computeTI(); alert('TI (Tackles+Interceptions) terisi otomatis.'); });

  $('btnCSR').addEventListener('click', ()=>{ computeCSR_GA_SAVE(); alert('CSR / GA / SAVE dihitung.'); });

  $('btnCR').addEventListener('click', ()=>{ computeCR(); alert('Conversion Rate dihitung.'); });

  $('btnBigIdx').addEventListener('click', ()=>{ computeBigIdx(); alert('Big Chance index terisi.'); });

  $('btnAutoForm').addEventListener('click', ()=>{ computeFormH2H(); alert('Form & H2H terisi.'); });



  ['tackleHome','interHome','tackleAway','interAway'].forEach(id=>{ const el=$(id); if(el) el.addEventListener('input', computeTI); });



  $('modeLeague').addEventListener('click', setModeLeague);

  $('modeCup').addEventListener('click', setModeCup);



  // initial

  setModeLeague();

});

</script>

</body>

</html>
