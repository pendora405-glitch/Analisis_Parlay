<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prediksi Global v20.8 Elite — Auto Advance Metrics</title>

<style>
:root{
  --bg:#071427; 
  --card:#0b1620; 
  --muted:#9fb0bf; 
  --accent:#18b2c9;
  --attack:#ff8a4c; 
  --defense:#4ea1ff; 
  --good:#10b981; 
  --bad:#fb7185;
}

*{
  box-sizing:border-box;
}

body{
  font-family:Inter,system-ui,Segoe UI,Arial;
  margin:0; padding:12px;
  background:linear-gradient(180deg,#031521 0%, #071427 100%);
  color:#eaf6fb;
}

h1{
  font-size:20px;
  margin:10px 0;
  color:var(--accent);
}

.card{
  background:var(--card);
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
  box-shadow:0 8px 30px rgba(0,0,0,0.55);
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

label{
  font-size:13px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
}

input,select,button{
  font-size:13px;
}

input,select{
  padding:6px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,0.08);
  background:transparent;
  color:inherit;
}

input[type=number]{
  width:120px;
}

button{
  background:var(--accent);
  border:0;
  padding:8px 12px;
  border-radius:8px;
  color:#021216;
  cursor:pointer;
}

.smallBtn{
  padding:5px 8px;
  border-radius:6px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.05);
  color:var(--muted);
}

.grid-3{
  display:grid;
  grid-template-columns:1fr 480px 320px;
  gap:12px;
}

@media(max-width:1250px){
  .grid-3{
    grid-template-columns:1fr;
  }
}

#toast{
  position:fixed;
  bottom:14px;
  right:14px;
  background:#082635;
  color:#dbf7fb;
  padding:10px 16px;
  border-radius:6px;
  opacity:0;
  transition:opacity .25s;
  z-index:999;
  font-size:13px;
}

#toast.show{
  opacity:1;
}

.pre{
  background:#02121a;
  padding:10px;
  border-radius:8px;
  color:#d8f7f9;
  white-space:pre-wrap;
  max-height:360px;
  overflow:auto;
}

.legend{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}

.footer-small{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:10px;
}

#tournamentBadge{
  margin-top:6px;
  font-size:15px;
  display:flex;
  align-items:center;
  gap:8px;
}

.flag{
  width:20px;
  height:14px;
  border-radius:3px;
  object-fit:cover;
}
</style>
</head>

<body>

<h1>⚽ Prediksi Global v20.8 — ELITE + Auto Advance Metrics</h1>

<div class="card small">
Versi 20.8 — Semua modul Tier-1..3, Auto Style, Auto Advance Metrics, Tournament Engine, ZeroBias, AntiBias, TrapIndex, HT Predictor, Penalty KO Predict, WebWorker Monte Carlo, Export CSV & Logging.  
Tidak ada contoh data — semua murni dari input.
</div>

<div id="toast"></div>

<!-- ===================== GLOBAL CONTROL ====================== -->

<div class="card row">
  <label>League GPG <input id="league_gpg" type="number" step="0.01"></label>
  <label>League Profile 
    <select id="league_profile">
      <option value="medium">Medium</option>
      <option value="high">High Scoring</option>
      <option value="low">Low Scoring</option>
    </select>
  </label>

  <label>Market OU <input id="market_ou" type="number" step="0.1"></label>

  <label>MC Iter
    <select id="mc_select">
      <option value="5000">5000</option>
      <option value="10000" selected>10000</option>
      <option value="20000">20000</option>
    </select>
  </label>

  <label>Match Type
    <select id="match_type">
      <option value="Regular">Regular</option>
      <option value="Derby">Derby</option>
      <option value="Final">Final</option>
      <option value="Friendly">Friendly</option>
      <option value="Relegation">Relegation</option>
    </select>
  </label>

  <label>Competition
    <select id="comp_mode">
      <option>Club</option>
      <option>Cup</option>
      <option>Playoff</option>
      <option>Super Cup</option>
      <option>International</option>
    </select>
  </label>

  <label>Tournament
    <select id="tournament_mode">
      <option value="none">None</option>
      <option value="wq">World Cup Qualifiers</option>
      <option value="wc">World Cup</option>
      <option value="euro">EURO</option>
      <option value="copa">Copa America</option>
      <option value="afcon">AFCON</option>
      <option value="asia">Asian Cup</option>
      <option value="goldcup">Gold Cup</option>
      <option value="nl">Nations League</option>
      <option value="friendly">Friendly</option>
    </select>
  </label>

  <label>Weather
    <select id="weather">
      <option>Normal</option>
      <option>Rain</option>
      <option>Snow</option>
      <option>Hot</option>
    </select>
  </label>

  <button id="analyzeBtn">Analisis</button>

  <label><input id="bayes_mode" type="checkbox"> Bayesian</label>
  <label><input id="zero_bias_mode" type="checkbox" checked> ZeroBias</label>
</div>

<!-- ======================= GRID LAYOUT ========================== -->

<div class="grid-3">

  <!-- ============ LEFT COLUMN (HOME + AWAY INPUT) ============= -->

  <div>

    <!-- ======================= HOME INPUT ====================== -->

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">HOME — Input</div>

      <div class="row">
        <label>Team<input id="h_name" type="text"></label>
        <label>GPG<input id="h_gpg" type="number" step="0.01"></label>
        <label>GC<input id="h_gc" type="number" step="0.01"></label>
      </div>

      <div class="row">
        <label>Shots<input id="h_shots" type="number" step="0.1"></label>
        <label>SOT<input id="h_sot" type="number" step="0.1"></label>
        <label>Conv%<input id="h_conv" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoConv('h')">Auto Conv</button>
      </div>

      <div class="row">
        <label>Poss%<input id="h_poss" type="number" step="0.1"></label>
        <label>ShotsC<input id="h_shotsC" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoShotsC('h')">Auto ShotsC</button>
        <label>Cross%<input id="h_cr" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoCross('h')">Auto Cross</button>
      </div>

      <div class="row">
        <label>Profile
          <select id="h_profile">
            <option value="auto">Auto</option>
            <option value="attack">Attack</option>
            <option value="defense">Defense</option>
            <option value="strong">Strong</option>
            <option value="weak">Weak</option>
            <option value="balanced">Balanced</option>
          </select>
        </label>

        <label>ELO<input id="h_elo" type="number"></label>
        <label>PAC%<input id="h_pac" type="number" step="0.1"></label>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted);font-weight:600">Tactical / Style (Home)</div>

      <div class="row">
        <label>Style
          <select id="h_style">
            <option value="possession">Possession</option>
            <option value="direct">Direct</option>
            <option value="counter">Counter</option>
            <option value="press">Pressing</option>
            <option value="lowblock">Low Block</option>
          </select>
        </label>

        <label>Press
          <select id="h_press">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </label>

        <label>Height
          <select id="h_height">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </label>

        <button class="smallBtn" onclick="applyAutoStyle('h')">Auto Style</button>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted);font-weight:600">Absensi & Importance</div>

      <div class="row">
        <label>GK abs<input id="h_gk_abs" type="number"></label>
        <label>DF abs<input id="h_df_abs" type="number"></label>
        <label>MD abs<input id="h_md_abs" type="number"></label>
        <label>FW abs<input id="h_fw_abs" type="number"></label>

        <label>PAF%<input id="h_paf" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoPAF('h')">Auto PAF</button>
      </div>

      <div class="row">
        <label>Importance
          <select id="h_importance">
            <option value="low">Low</option>
            <option value="med" selected>Medium</option>
            <option value="high">High</option>
            <option value="must">Must Win</option>
          </select>
        </label>

        <label>Rotation
          <select id="h_rotation">
            <option value="0">None</option>
            <option value="1">Light</option>
            <option value="2">Medium</option>
            <option value="3">Heavy</option>
          </select>
        </label>

        <label>Key Player Missing
          <select id="h_keymiss">
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </label>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted);font-weight:600">
        Advanced Metrics
      </div>

      <div class="row">
        <label>Prog<input id="h_prog" type="number" step="0.1"></label>
        <label>Final3<input id="h_final3" type="number" step="0.1"></label>
        <label>Inter<input id="h_inter" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="applyAutoAdv('h')">Auto Advance</button>
      </div>

    </div>

    <!-- ======================= AWAY INPUT ======================= -->

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">AWAY — Input</div>

      <div class="row">
        <label>Team<input id="a_name" type="text"></label>
        <label>GPG<input id="a_gpg" type="number" step="0.01"></label>
        <label>GC<input id="a_gc" type="number" step="0.01"></label>
      </div>

      <div class="row">
        <label>Shots<input id="a_shots" type="number" step="0.1"></label>
        <label>SOT<input id="a_sot" type="number" step="0.1"></label>
        <label>Conv%<input id="a_conv" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoConv('a')">Auto Conv</button>
      </div>

      <div class="row">
        <label>Poss%<input id="a_poss" type="number" step="0.1"></label>
        <label>ShotsC<input id="a_shotsC" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoShotsC('a')">Auto ShotsC</button>
        <label>Cross%<input id="a_cr" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoCross('a')">Auto Cross</button>
      </div>

      <div class="row">
        <label>Profile
          <select id="a_profile">
            <option value="auto">Auto</option>
            <option value="attack">Attack</option>
            <option value="defense">Defense</option>
            <option value="strong">Strong</option>
            <option value="weak">Weak</option>
            <option value="balanced">Balanced</option>
          </select>
        </label>

        <label>ELO<input id="a_elo" type="number"></label>
        <label>PAC%<input id="a_pac" type="number" step="0.1"></label>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted);font-weight:600">Tactical / Style (Away)</div>

      <div class="row">
        <label>Style
          <select id="a_style">
            <option value="possession">Possession</option>
            <option value="direct">Direct</option>
            <option value="counter">Counter</option>
            <option value="press">Pressing</option>
            <option value="lowblock">Low Block</option>
          </select>
        </label>

        <label>Press
          <select id="a_press">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </label>

        <label>Height
          <select id="a_height">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </label>

        <button class="smallBtn" onclick="applyAutoStyle('a')">Auto Style</button>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted);font-weight:600">Absensi & Importance</div>

      <div class="row">
        <label>GK abs<input id="a_gk_abs" type="number"></label>
        <label>DF abs<input id="a_df_abs" type="number"></label>
        <label>MD abs<input id="a_md_abs" type="number"></label>
        <label>FW abs<input id="a_fw_abs" type="number"></label>

        <label>PAF%<input id="a_paf" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="autoPAF('a')">Auto PAF</button>
      </div>

      <div class="row">
        <label>Importance
          <select id="a_importance">
            <option value="low">Low</option>
            <option value="med" selected>Medium</option>
            <option value="high">High</option>
            <option value="must">Must Win</option>
          </select>
        </label>

        <label>Rotation
          <select id="a_rotation">
            <option value="0">None</option>
            <option value="1">Light</option>
            <option value="2">Medium</option>
            <option value="3">Heavy</option>
          </select>
        </label>

        <label>Key Missing
          <select id="a_keymiss">
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </label>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted);font-weight:600">Advanced Metrics</div>

      <div class="row">
        <label>Prog<input id="a_prog" type="number" step="0.1"></label>
        <label>Final3<input id="a_final3" type="number" step="0.1"></label>
        <label>Inter<input id="a_inter" type="number" step="0.1"></label>
        <button class="smallBtn" onclick="applyAutoAdv('a')">Auto Advance</button>
      </div>

    </div>

    <!-- ============ ODDS & OTHER CONTROL BUTTONS ================= -->

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">Odds & Market</div>

      <div class="row">
        <label>Home Odds<input id="odds_home" type="number" step="0.01"></label>
        <label>Away Odds<input id="odds_away" type="number" step="0.01"></label>
      </div>

      <div class="row">
        <label>HDP Open<input id="odds_hdp_open" type="number" step="0.01"></label>
        <label>HDP Now<input id="odds_hdp_now" type="number" step="0.01"></label>
      </div>

      <div class="row">
        <label>Over Odds<input id="odds_over" type="number" step="0.01"></label>
        <label>Under Odds<input id="odds_under" type="number" step="0.01"></label>
      </div>
    </div>

    <div class="card row">
      <button id="autoCalcStats">Auto Hitung Statistik</button>
      <button id="autoEnhancedBtn">Enhanced Stats</button>
      <button id="manualCalcBtn">Hitung Manual</button>
      <button id="exportBtn">Export CSV</button>
      <button id="viewHistory">History</button>
      <button id="resetBtn">Reset Input</button>
      <button id="inputRealBtn">Input Skor</button>
    </div>

  </div>

  <!-- ================= CENTER COLUMN ================== -->

  <div>

    <div class="card">
      <div id="tournamentBadge"></div>
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">Hasil Analisis</div>
      <div id="resultText" class="pre"></div>
    </div>

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">Distribusi Skor</div>
      <div id="scoreDist" class="pre"></div>
    </div>

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">Radar Match Profile</div>
      <canvas id="radarCanvas" width="380" height="380"></canvas>
      <div class="legend">Attack • Defense • Clash • Momentum • xT/xTA</div>
    </div>

  </div>

  <!-- ================= RIGHT COLUMN ================= -->

  <div>

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">Trend Analisis</div>
      <div id="trendText" class="pre"></div>
    </div>

    <div class="card">
      <div style="font-weight:600;color:#bfeef8;margin-bottom:6px">History</div>
      <div id="historyList" class="pre"></div>
    </div>

  </div>

</div>

<div class="footer-small">
v20.8 ELITE — Clean file (No sample data) · Netral · Anti-Bias · Real-time input engine.
</div>

<script>
/* ============================================================
   PART 2 — UTILITIES, AUTO FUNCTIONS, VALIDATION, BASE CALC
   ============================================================ */

/* ----------------- UTIL ----------------- */
function showToast(msg,ms=1600){
  const t=document.getElementById("toast"); 
  if(!t) return;
  t.textContent=msg; 
  t.classList.add("show");
  clearTimeout(window._qpe_toast); 
  window._qpe_toast=setTimeout(()=>t.classList.remove("show"), ms);
}

function clamp(v,a,b){ 
  return Math.min(b,Math.max(a,v)); 
}

function pct(x){ 
  return (x*100).toFixed(1) + "%"; 
}


/* ----------------- AUTO ASSIST ----------------- */
function autoConv(side){
  let shots=parseFloat(document.getElementById(side+"_shots").value)||0;
  let sot=parseFloat(document.getElementById(side+"_sot").value)||0;

  if(shots<=0 || sot>shots){
    showToast("AutoConv: data tidak valid");
    return;
  }

  let conv=(sot/shots)*100;
  document.getElementById(side+"_conv").value = conv.toFixed(1);
  showToast(side.toUpperCase()+" Conv% otomatis terisi");
}

function autoShotsC(side){
  let gc = parseFloat(document.getElementById(side+"_gc").value)||0;
  let est = gc * 2.5;
  document.getElementById(side+"_shotsC").value = est.toFixed(1);
  showToast("Shots Conceded otomatis terisi");
}

function autoCross(side){
  let shots=parseFloat(document.getElementById(side+"_shots").value)||0;
  let est = clamp(shots*4.2, 8, 40);
  document.getElementById(side+"_cr").value = est.toFixed(1);
  showToast("Cross% otomatis terisi");
}

function autoPAF(side){
  let df=parseFloat(document.getElementById(side+"_df_abs").value)||0;
  let md=parseFloat(document.getElementById(side+"_md_abs").value)||0;
  let fw=parseFloat(document.getElementById(side+"_fw_abs").value)||0;

  let paf = 100 - (df*3 + md*2 + fw*2.5);
  paf = clamp(paf, 55, 110);

  document.getElementById(side+"_paf").value = paf.toFixed(1);
  showToast("PAF otomatis terisi");
}


/* ----------------- VALIDATION ----------------- */
function validateInput(h,a){
  let ok = true;
  let warn = [];

  if(h.sot > h.shots){ warn.push("Home SOT > Shots"); ok=false; }
  if(a.sot > a.shots){ warn.push("Away SOT > Shots"); ok=false; }

  if(h.gc > h.shotsC){ warn.push("GC Home > ShotsC"); }
  if(a.gc > a.shotsC){ warn.push("GC Away > ShotsC"); }

  if(h.poss < 20 || h.poss > 80){ warn.push("Poss Home tidak wajar"); }
  if(a.poss < 20 || a.poss > 80){ warn.push("Poss Away tidak wajar"); }

  if(h.conv > 70 || a.conv > 70){ warn.push("Conv% terlalu tinggi"); }

  if(warn.length){
    showToast(warn.join(" • "), 3000);
  }

  return ok;
}


/* ----------------- STYLE NUMERIC CONVERSION ----------------- */
function styleToNum(x){
  if(x==="possession") return 0.2;
  if(x==="direct")     return 0.55;
  if(x==="counter")    return 0.7;
  if(x==="press")      return 0.8;
  if(x==="lowblock")   return 0.1;
  return 0.4;
}

function pressToNum(x){
  if(x==="low") return 0.2;
  if(x==="medium") return 0.5;
  return 0.8;
}

function heightToNum(x){
  if(x==="low") return 0.2;
  if(x==="medium") return 0.5;
  return 0.8;
}


/* ----------------- XG+, FEI, DSI ----------------- */
function calcXGPlus(team){
  let xg = (team.shots*0.035)
        + (team.sot*0.12)
        + (team.conv/100)*0.4
        + (team.poss*0.0045)
        + (team.cr*0.22/100);

  if(team.prog)  xg += team.prog*0.02;
  if(team.final3) xg += team.final3*0.014;

  return clamp(xg, 0.05, 6.0);
}

function calcFEI(team){
  if(team.xg <= 0) return 1;
  let r = team.gpg / team.xg;
  return clamp( 0.92 + (r-1)*0.5, 0.7, 1.35 );
}

function calcDSI(team){
  let base = 1 + Math.log(1 + team.shotsC)*0.055 - (team.gc*0.06);
  let abs  = (team.df_abs*0.03) + (team.md_abs*0.015) + (team.gk_abs*0.05);
  return clamp(base + abs, 0.45, 2.8);
}


/* ----------------- PROFILE & ELO ----------------- */
function classifyTeam(xG,xGA){
  if(xG>1.6 && xGA<1.0) return "strong";
  if(xG>1.6 && xGA>1.3) return "attack";
  if(xG<1.1 && xGA<1.0) return "defense";
  if(xG<1.1 && xGA>1.3) return "weak";
  return "balanced";
}

function profileMultiplier(profile){
  if(profile==="strong") return {atk:1.06, def:1.06};
  if(profile==="attack") return {atk:1.07, def:0.94};
  if(profile==="defense")return {atk:0.94, def:1.06};
  if(profile==="weak")  return {atk:0.92, def:0.92};
  return {atk:1.0, def:1.0};
}

function eloFactor(e1,e2){
  if(!e1 || !e2) return 1;
  let diff = e1 - e2;
  return clamp(1/(1+Math.exp(-diff/500)), 0.85, 1.18);
}


/* ----------------- PARKIR BUS DETECTION ----------------- */
function parkirBusSignal(team,opp){
  let p = 0;

  if(team.poss < 38) p += 0.28;
  if(team.style==="lowblock") p += 0.35;
  if(team.shots < 8) p += 0.18;
  if((team.final3||0) < 6) p += 0.12;

  // Salah satu tim difavoritkan
  if(opp.xg > 1.5 && team.xg < 0.9) p += 0.14;

  return clamp(p,0,1);
}


/* ----------------- TACTICAL CLASH ----------------- */
function tacticalClash(h,a){
  let clash = 0;

  clash += Math.abs(styleToNum(h.style) - styleToNum(a.style));
  clash += Math.abs(pressToNum(h.press) - pressToNum(a.press)) * 0.45;
  clash += Math.abs(heightToNum(h.height) - heightToNum(a.height)) * 0.3;

  return clamp(clash, 0, 2);
}
/* ============================================================
   PART 3 — MOMENTUM, TIER-3 METRICS, TOURNAMENT, HT, PENALTY
   ============================================================ */


/* ----------------- MOMENTUM ENGINE ----------------- */
function calcMomentum(h,a){
  let tmH = (h.shots*0.06) + (h.sot*0.08) + (h.cr*0.035) + (h.inter*0.02);
  let tmA = (a.shots*0.06) + (a.sot*0.08) + (a.cr*0.035) + (a.inter*0.02);

  return {
    h: clamp((tmH/6.5), 0.75, 1.20),
    a: clamp((tmA/6.5), 0.75, 1.20)
  };
}


/* ----------------- IMPORTANCE, ROTATION, KEYMISS ----------------- */
function importanceFactor(x){
  if(x==="low") return 1.00;
  if(x==="med") return 1.02;
  if(x==="high") return 1.05;
  return 1.08; // must win
}

function rotationPenalty(r){
  if(r==="0") return 0;
  if(r==="1") return 0.04;
  if(r==="2") return 0.08;
  return 0.12;
}

function keyMissingPenalty(x){
  return (x==="1") ? 0.10 : 0;
}


/* ----------------- TIER-3 (ADVANCED METRICS) ----------------- */

function calcXT(team){
  let xt=0;
  if(team.prog) xt += team.prog * 0.015;
  if(team.final3) xt += team.final3 * 0.022;
  xt += (team.sot||0) * 0.06;
  return clamp(xt, 0, 2.2);
}

function calcXTA(team){
  let x = (team.shotsC||0)*0.014 + (team.gc||0)*0.25;
  return clamp(x, 0, 2);
}

function calcPBCM(team){
  let val = (team.poss*0.01) + (team.shots*0.008) + (team.cr*0.0028);
  return clamp(val, 0.3, 1.6);
}

function calcGDPM(h,a){
  return clamp(
    ((h.pbc||0)+(a.pbc||0))/2 + Math.abs((h.poss||0)-(a.poss||0))*0.01,
    0.4, 1.8
  );
}

function calcSFI(team){
  let f = (team.dsi||1)*0.1 + (team.gk_abs||0)*0.2 + (team.df_abs||0)*0.06;
  return clamp(f, 0, 1);
}

function calcAGV(h,a,clash){
  let v = 0.8 + clash*0.15 + ((h.mom||1)+(a.mom||1))/10;
  return clamp(v, 0.6, 1.5);
}

function calcSPT(team){
  return clamp((team.cr*0.002) + (team.final3*0.015), 0, 0.5);
}

function calcCFEM(matchType){
  if(matchType==="Derby") return 0.12;
  if(matchType==="Relegation") return 0.10;
  return 0.05;
}

function calcOZR(team){
  return clamp((team.inter||0)*0.03, 0, 0.6);
}


/* ----------------- TOURNAMENT ENGINE (ELITE EDITION) ----------------- */
function tournamentPreset(t){
  let cfg = {
    lambda_mult:1.00,
    momentum_mult:1.00,
    volatility_mult:1.00,
    importance_boost:1.00,
    defense_tightness:1.00,
    setpiece_boost:1.00
  };

  switch(t){
    case "wq":
      cfg.lambda_mult=0.96;
      cfg.momentum_mult=1.05;
      cfg.volatility_mult=1.08;
      cfg.importance_boost=1.12;
      cfg.defense_tightness=1.02;
      break;

    case "wc":
      cfg.lambda_mult=0.93;
      cfg.momentum_mult=1.10;
      cfg.volatility_mult=1.15;
      cfg.importance_boost=1.20;
      cfg.defense_tightness=1.04;
      cfg.setpiece_boost=1.08;
      break;

    case "euro":
      cfg.lambda_mult=0.95;
      cfg.momentum_mult=1.08;
      cfg.volatility_mult=1.12;
      cfg.importance_boost=1.18;
      cfg.defense_tightness=1.03;
      break;

    case "copa":
      cfg.lambda_mult=0.98;
      cfg.momentum_mult=1.12;
      cfg.volatility_mult=1.20;
      cfg.importance_boost=1.15;
      break;

    case "afcon":
      cfg.lambda_mult=1.02;
      cfg.momentum_mult=1.12;
      cfg.volatility_mult=1.20;
      cfg.importance_boost=1.10;
      break;

    case "asia":
      cfg.lambda_mult=1.00;
      cfg.momentum_mult=1.08;
      cfg.volatility_mult=1.15;
      cfg.importance_boost=1.15;
      break;

    case "goldcup":
      cfg.lambda_mult=1.05;
      cfg.momentum_mult=1.10;
      cfg.volatility_mult=1.22;
      cfg.importance_boost=1.12;
      break;

    case "nl":
      cfg.lambda_mult=0.99;
      cfg.momentum_mult=1.06;
      cfg.volatility_mult=1.10;
      cfg.importance_boost=1.08;
      break;

    case "friendly":
      cfg.lambda_mult=1.02;
      cfg.momentum_mult=0.88;
      cfg.volatility_mult=0.70;
      cfg.importance_boost=0.80;
      cfg.defense_tightness=0.92;
      break;
  }

  return cfg;
}


/* ----------------- FIRST HALF (HT) PREDICTOR ----------------- */
function calcHT(lambdaH,lambdaA,matchType,tournament){
  let multH = 0.52, multA = 0.52;

  if(tournament==="wc" || tournament==="euro"){
    multH = 0.46;
    multA = 0.46;
  }

  if(matchType==="Derby"){
    multH -= 0.02;
    multA -= 0.02;
  }

  let h = lambdaH * multH;
  let a = lambdaA * multA;

  let denom = h + a + 0.6;
  let pH = clamp(h / denom, 0, 1);
  let pA = clamp(a / denom, 0, 1);
  let pD = clamp(1 - (pH + pA), 0, 1);

  return {
    htH:h,
    htA:a,
    probH:pH,
    probD:pD,
    probA:pA
  };
}


/* ----------------- PENALTY SHOOTOUT PREDICTOR ----------------- */
function calcPenalties(h,a,tournament){
  if(!(tournament==="wc"|| tournament==="euro"|| tournament==="copa"|| tournament==="afcon")){
    return null;
  }

  let gkH = 1 - (h.gk_abs||0)*0.3;
  let gkA = 1 - (a.gk_abs||0)*0.3;

  let nerveH = 1 - (h.sfi||0)*0.2;
  let nerveA = 1 - (a.sfi||0)*0.2;

  let scoreH = gkH*0.55 + nerveH*0.45;
  let scoreA = gkA*0.55 + nerveA*0.45;

  let pH = scoreH/(scoreH+scoreA);
  let pA = scoreA/(scoreH+scoreA);

  return {
    pH: clamp(pH,0,1),
    pA: clamp(pA,0,1)
  };
}


/* ----------------- AUTO ADVANCE METRICS ENGINE ----------------- */
function autoAdvMetrics(team){
  let poss = team.poss || 50;
  let shots = team.shots || 10;
  let cr = team.cr || 15;
  let gc = team.gc || 1;
  let shotsC = team.shotsC || 10;
  let style = team.style || "balanced";
  let press = team.press || "medium";

  /* ---- PROGRESSIVE PASSES ---- */
  let prog =
    (poss * 0.28) +
    (shots * 0.9) +
    (cr * 0.12);

  if(style==="possession") prog *= 1.20;
  if(style==="direct")     prog *= 0.85;
  if(style==="counter")    prog *= 1.10;
  if(style==="press")      prog *= 1.05;
  if(style==="lowblock")   prog *= 0.75;

  if(press==="high") prog *= 1.08;
  if(press==="low")  prog *= 1.08;

  prog = clamp(prog/10, 3, 30);

  /* ---- FINAL THIRD ENTRIES ---- */
  let final3 =
    (poss * 0.42) +
    (shots * 1.6) +
    (cr * 0.18);

  if(style==="possession") final3 *= 1.15;
  if(style==="direct")     final3 *= 1.12;
  if(style==="counter")    final3 *= 1.18;
  if(style==="press")      final3 *= 1.10;
  if(style==="lowblock")   final3 *= 0.75;

  final3 = clamp(final3/10, 8, 40);

  /* ---- INTERCEPTIONS ---- */
  let inter =
    (shotsC * 0.6) +
    (gc * 1.8);

  if(press==="high") inter *= 1.25;
  if(press==="medium") inter *= 1.05;

  if(style==="lowblock") inter *= 1.15;
  if(style==="possession") inter *= 0.90;

  inter = clamp(inter, 5, 25);

  return {
    prog:Number(prog.toFixed(1)),
    final3:Number(final3.toFixed(1)),
    inter:Number(inter.toFixed(1))
  };
}

function applyAutoAdv(side){
  const g = id => parseFloat(document.getElementById(id).value)||0;

  let team = {
    poss:g(side+"_poss"),
    shots:g(side+"_shots"),
    cr:g(side+"_cr"),
    gc:g(side+"_gc"),
    shotsC:g(side+"_shotsC"),
    style:document.getElementById(side+"_style").value,
    press:document.getElementById(side+"_press").value
  };

  let adv = autoAdvMetrics(team);

  document.getElementById(side+"_prog").value = adv.prog;
  document.getElementById(side+"_final3").value = adv.final3;
  document.getElementById(side+"_inter").value = adv.inter;

  showToast("Auto Advance Metrics terisi untuk "+(side==="h"?"Home":"Away"));
}
/* ============================================================
   PART 4 — MASTER INPUT LOADER + LAMBDA ENGINE + PROBABILITY
   ============================================================ */


/* -------------------- INPUT LOADER ---------------------- */
function loadTeam(side){

  const g = id => parseFloat(document.getElementById(id).value)||0;

  let t = {
    name     : document.getElementById(side+"_name").value || (side==="h"?"Home":"Away"),

    gpg      : g(side+"_gpg"),
    gc       : g(side+"_gc"),

    shots    : g(side+"_shots"),
    sot      : g(side+"_sot"),
    conv     : g(side+"_conv"),
    poss     : g(side+"_poss"),
    shotsC   : g(side+"_shotsC"),
    cr       : g(side+"_cr"),

    profile  : document.getElementById(side+"_profile").value,
    elo      : g(side+"_elo"),
    pac      : g(side+"_pac"),

    style    : document.getElementById(side+"_style").value,
    press    : document.getElementById(side+"_press").value,
    height   : document.getElementById(side+"_height").value,

    gk_abs   : g(side+"_gk_abs"),
    df_abs   : g(side+"_df_abs"),
    md_abs   : g(side+"_md_abs"),
    fw_abs   : g(side+"_fw_abs"),

    paf      : g(side+"_paf"),
    importance : document.getElementById(side+"_importance").value,
    rotation   : document.getElementById(side+"_rotation").value,
    keymiss    : document.getElementById(side+"_keymiss").value,

    prog     : g(side+"_prog"),
    final3   : g(side+"_final3"),
    inter    : g(side+"_inter")
  };

  return t;
}


/* -------------------- MAIN ANALYSIS ---------------------- */
document.getElementById("analyzeBtn").addEventListener("click", mainAnalyze);

function mainAnalyze(){
  // Load teams
  let h = loadTeam("h");
  let a = loadTeam("a");

  // Validate
  validateInput(h,a);

  // Tournament preset
  let tournament = document.getElementById("tournament_mode").value;
  let T = tournamentPreset(tournament);

  // Apply base calculations
  h.xg = calcXGPlus(h);
  a.xg = calcXGPlus(a);

  h.fei = calcFEI(h);
  a.fei = calcFEI(a);

  h.dsi = calcDSI(h);
  a.dsi = calcDSI(a);

  // Profile
  if(h.profile==="auto") h.profile = classifyTeam(h.xg,h.gc);
  if(a.profile==="auto") a.profile = classifyTeam(a.xg,a.gc);

  let mh = profileMultiplier(h.profile);
  let ma = profileMultiplier(a.profile);

  // Apply multipliers
  h.xg *= mh.atk;
  a.xg *= ma.atk;

  // Momentum
  let M = calcMomentum(h,a);
  h.mom = M.h;
  a.mom = M.a;

  // xT/xTA
  h.xt = calcXT(h);
  a.xt = calcXT(a);
  h.xta = calcXTA(h);
  a.xta = calcXTA(a);

  // PBCM
  h.pbc = calcPBCM(h);
  a.pbc = calcPBCM(a);

  // GDPM
  let gdpm = calcGDPM(h,a);

  // SFI
  h.sfi = calcSFI(h);
  a.sfi = calcSFI(a);

  // Parkir bus
  let pbH = parkirBusSignal(h,a);
  let pbA = parkirBusSignal(a,h);

  // Tactical clash
  let clash = tacticalClash(h,a);

  // AGV
  let agv = calcAGV(h,a,clash);

  // SPT
  h.spt = calcSPT(h);
  a.spt = calcSPT(a);

  // OZR
  h.ozr = calcOZR(h);
  a.ozr = calcOZR(a);

  // Importance
  let impH = importanceFactor(h.importance);
  let impA = importanceFactor(a.importance);

  // Rotation penalties
  let rH = rotationPenalty(h.rotation);
  let rA = rotationPenalty(a.rotation);

  // Key missing
  let kH = keyMissingPenalty(h.keymiss);
  let kA = keyMissingPenalty(a.keymiss);

  // Home advantage
  let matchType = document.getElementById("match_type").value;
  let HA = homeAdv(matchType);

  // ELO factor
  let eloF = eloFactor(h.elo, a.elo);

  // Final strength calculation
  let strengthH =
      h.xg * h.fei * h.mom *
      impH *
      (1 - rH) *
      (1 - kH) *
      HA *
      (1 - pbH*0.20) *
      (1 + h.spt*0.15) *
      (1 - h.ozr*0.05) *
      (1 + h.xt*0.06) *
      (1 - h.xta*0.04) *
      (1 + (eloF-1)*0.9);

  let strengthA =
      a.xg * a.fei * a.mom *
      impA *
      (1 - rA) *
      (1 - kA) *
      (1 - pbA*0.20) *
      (1 + a.spt*0.15) *
      (1 - a.ozr*0.05) *
      (1 + a.xt*0.06) *
      (1 - a.xta*0.04) *
      (1 - (eloF-1)*0.9);

  // GDPM effect
  strengthH *= (1 + gdpm*0.02);
  strengthA *= (1 + gdpm*0.02);

  // Tactical clash
  strengthH *= (1 - clash*0.05);
  strengthA *= (1 - clash*0.05);

  /* =========================
       TOURNAMENT MODIFIERS
     ========================= */
  strengthH *= T.lambda_mult;
  strengthA *= T.lambda_mult;

  h.mom *= T.momentum_mult;
  a.mom *= T.momentum_mult;

  agv *= T.volatility_mult;

  // Defense tightening
  strengthH *= (1 - (T.defense_tightness - 1)*0.08);
  strengthA *= (1 - (T.defense_tightness - 1)*0.08);

  // Set piece boost
  strengthH *= (1 + h.spt*T.setpiece_boost*0.1);
  strengthA *= (1 + a.spt*T.setpiece_boost*0.1);


  /* =========================
       LAMBDA INITIAL
     ========================= */
  let lambdaH = clamp(strengthH, 0.05, 4.5);
  let lambdaA = clamp(strengthA, 0.05, 4.5);

  /* =========================
       ZERO BIAS ENGINE
     ========================= */
  let zb = document.getElementById("zero_bias_mode").checked;
  if(zb){
    let market_ou = parseFloat(document.getElementById("market_ou").value)||2.5;
    let z = applyZeroBias(lambdaH, lambdaA, market_ou);
    lambdaH = z.h;
    lambdaA = z.a;
  }

  /* =========================
       ANTI-BIAS PROTECTOR
     ========================= */
  lambdaH = antiBias(lambdaH);
  lambdaA = antiBias(lambdaA);

  /* =========================
       ASIAN HANDICAP TRAP INDEX
     ========================= */
  let oddsH = parseFloat(document.getElementById("odds_home").value)||0;
  let oddsA = parseFloat(document.getElementById("odds_away").value)||0;
  let hdpOpen = parseFloat(document.getElementById("odds_hdp_open").value)||0;
  let hdpNow  = parseFloat(document.getElementById("odds_hdp_now").value)||0;

  let trap = trapIndex(oddsH, oddsA, hdpOpen, hdpNow);


  /* =========================
       CONFIDENCE ENGINE
     ========================= */
  let variance = agv;
  let conf = confidenceGrid(lambdaH, lambdaA, variance, trap);


  /* =========================
       BAYES CALIBRATION
     ========================= */
  let bayes = document.getElementById("bayes_mode").checked;
  if(bayes){
    lambdaH = lambdaH*0.92 + h.gpg*0.08;
    lambdaA = lambdaA*0.92 + a.gpg*0.08;
  }

  /* ======================================================
        PROBABILITY 1x2 USING POISSON CORE MODEL
     ====================================================== */

  let maxGoals = 7; 
  let px = [];

  for(let i=0;i<=maxGoals;i++){
    px[i] = [];
    for(let j=0;j<=maxGoals;j++){
      let ph = Math.pow(lambdaH,i) * Math.exp(-lambdaH) / factorial(i);
      let pa = Math.pow(lambdaA,j) * Math.exp(-lambdaA) / factorial(j);
      px[i][j] = ph * pa;
    }
  }

  let pHome=0, pDraw=0, pAway=0;
  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      if(i>j) pHome+=px[i][j];
      else if(i===j) pDraw+=px[i][j];
      else pAway+=px[i][j];
    }
  }

  let prob = ORL({home:pHome, draw:pDraw, away:pAway});


  /* =========================
         FIRST HALF
     ========================= */
  let ht = calcHT(lambdaH, lambdaA, matchType, tournament);


  /* =========================
         PENALTY KO
     ========================= */
  let pen = calcPenalties(h,a,tournament);


  /* =========================
         OUTPUT TO DOM
     ========================= */
  buildOutput(h,a,lambdaH,lambdaA,prob,ht,pen,clash,trap,conf,agv);
}


/* ================================
       FACTORIAL
================================ */
function factorial(n){ 
  if(n<=1) return 1;
  let r=1; for(let i=2;i<=n;i++) r*=i;
  return r;
}
/* ============================================================
   PART 5 — OUTPUT, RADAR, HISTORY, MC WORKER, UI BINDINGS, END
   ============================================================ */

/* ----------------- Build Output & Render ----------------- */
function buildOutput(h,a,lambdaH,lambdaA,prob,ht,pen,clash,trap,conf,agv){
  // Result header
  const resEl = document.getElementById("resultText");
  let s = "";
  s += "<strong>λ Home:</strong> " + lambdaH.toFixed(3) + " &nbsp; <strong>λ Away:</strong> " + lambdaA.toFixed(3) + "<br/>";
  s += "<strong>Prob FT:</strong> Home: " + pct(prob.home) + " • Draw: " + pct(prob.draw) + " • Away: " + pct(prob.away) + "<br/>";
  s += "Confidence: " + (conf*100).toFixed(1) + "% &nbsp; • TrapIndex: " + trap.toFixed(2) + " &nbsp; • Clash: " + clash.toFixed(2) + "<br/>";
  s += "AGV: " + agv.toFixed(2) + "<br/><br/>";

  // HT
  if(ht){
    s += "<strong>Prediksi HT:</strong><br/>";
    s += "HT λ Home: " + ht.htH.toFixed(3) + " • HT λ Away: " + ht.htA.toFixed(3) + "<br/>";
    s += "HT Prob: Home " + pct(ht.probH) + " • Draw " + pct(ht.probD) + " • Away " + pct(ht.probA) + "<br/><br/>";
  }

  // Penalty KO (if any)
  if(pen){
    s += "<strong>Prediksi Penalti (KO):</strong> Home " + (pen.pH*100).toFixed(1) + "% • Away " + (pen.pA*100).toFixed(1) + "%<br/><br/>";
  }

  // Tactical notes
  s += "<strong>Tactical Summary:</strong><br/>";
  s += h.name + " — xG: " + h.xg.toFixed(2) + " | DSI: " + h.dsi.toFixed(2) + " | PBCM: " + h.pbc.toFixed(2) + "<br/>";
  s += a.name + " — xG: " + a.xg.toFixed(2) + " | DSI: " + a.dsi.toFixed(2) + " | PBCM: " + a.pbc.toFixed(2) + "<br/>";

  resEl.innerHTML = s;

  // Score distribution (from Poisson table computed previously in mainAnalyze)
  // Build a text list of most-likely scores
  let scoreEl = document.getElementById("scoreDist");
  let scores = {};
  // recompute distribution quickly to ensure availability
  const maxG = 7;
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const ph = Math.pow(lambdaH,i) * Math.exp(-lambdaH) / factorial(i);
      const pa = Math.pow(lambdaA,j) * Math.exp(-lambdaA) / factorial(j);
      const p = ph * pa;
      const key = i + "-" + j;
      scores[key] = (scores[key]||0) + p;
    }
  }
  // sort keys by probability desc
  const entries = Object.keys(scores).map(k=>[k,scores[k]]).sort((a,b)=>b[1]-a[1]);
  let sd = "";
  for(let k=0;k<Math.min(entries.length,18);k++){
    sd += entries[k][0] + ": " + (entries[k][1]*100).toFixed(2) + "%\n";
  }
  scoreEl.textContent = sd;

  // Trend / small summary
  const trendEl = document.getElementById("trendText");
  trendEl.textContent = `xG Home: ${h.xg.toFixed(2)} | xG Away: ${a.xg.toFixed(2)}
DSI Home: ${h.dsi.toFixed(2)} | DSI Away: ${a.dsi.toFixed(2)}
Momentum H:${h.mom.toFixed(2)} A:${a.mom.toFixed(2)}
xT H:${h.xt.toFixed(2)} A:${a.xt.toFixed(2)}
Fragility H:${h.sfi.toFixed(2)} A:${a.sfi.toFixed(2)}
`;

  // Radar
  drawRadar(h,a,clash);

  // save to history
  pushHistory({time:new Date().toLocaleString(), hname:h.name, aname:a.name, prob:prob, conf:conf, lambdaH:lambdaH, lambdaA:lambdaA});
}

/* ----------------- RADAR DRAW ----------------- */
function drawRadar(h,a,clash){
  const cv = document.getElementById("radarCanvas");
  if(!cv) return;
  const c = cv.getContext("2d");
  c.clearRect(0,0,cv.width,cv.height);
  const cx = cv.width/2, cy = cv.height/2;
  const r = Math.min(cx,cy) - 30;

  // background web
  c.strokeStyle = "rgba(200,230,235,0.06)";
  for(let i=1;i<=4;i++){
    c.beginPath();
    c.arc(cx,cy,(r/4)*i,0,Math.PI*2);
    c.stroke();
  }

  // values: attackH, defenseH, attackA, defenseA, clash
  const vAtkH = clamp(h.xg/2.4, 0, 1);
  const vDefH = clamp(1/(h.dsi||1), 0, 1.6);
  const vAtkA = clamp(a.xg/2.4, 0, 1);
  const vDefA = clamp(1/(a.dsi||1), 0, 1.6);
  const vClash = clamp(clash/2, 0, 1);

  const vals = [vAtkH, vDefH, vAtkA, vDefA, vClash];
  const ang = 2*Math.PI/5;

  // polygon
  c.beginPath();
  c.fillStyle = "rgba(24,178,201,0.06)";
  c.strokeStyle = "#18b2c9";
  for(let i=0;i<5;i++){
    const rad = vals[i]*r;
    const x = cx + rad * Math.cos(ang*i - Math.PI/2);
    const y = cy + rad * Math.sin(ang*i - Math.PI/2);
    if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
  }
  c.closePath();
  c.fill();
  c.stroke();

  // labels
  c.fillStyle = "#bfeef8";
  c.font = "12px sans-serif";
  const labels = ["AtkH","DefH","AtkA","DefA","Clash"];
  for(let i=0;i<5;i++){
    const x = cx + (r+18) * Math.cos(ang*i - Math.PI/2);
    const y = cy + (r+18) * Math.sin(ang*i - Math.PI/2);
    c.fillText(labels[i], x-12, y+4);
  }
}

/* ----------------- HISTORY HANDLING ----------------- */
let HISTORY = [];
function pushHistory(entry){
  HISTORY.unshift(entry);
  if(HISTORY.length>120) HISTORY.pop();
  renderHistory();
}

function renderHistory(){
  const el = document.getElementById("historyList");
  if(!el) return;
  let out = "";
  for(let it of HISTORY){
    out += `[${it.time}] ${it.hname} vs ${it.aname} → H:${(it.prob.home*100).toFixed(1)}% D:${(it.prob.draw*100).toFixed(1)}% A:${(it.prob.away*100).toFixed(1)}% (C:${(it.conf*100||0).toFixed(0)}%)\n`;
  }
  el.textContent = out;
}

/* ----------------- EXPORT CSV (LAST PREDICTION) ----------------- */
document.getElementById("exportBtn").addEventListener("click", ()=>{
  if(HISTORY.length===0){ showToast("Belum ada hasil untuk di-export"); return; }
  const last = HISTORY[0];
  const rows = [
    ["time","home","away","lambdaH","lambdaA","pHome","pDraw","pAway","conf"],
    [last.time,last.hname,last.aname,last.lambdaH,last.lambdaA,last.prob.home,last.prob.draw,last.prob.away,last.conf]
  ];
  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "prediksi_v20.8_result.csv"; a.click();
  URL.revokeObjectURL(url);
  showToast("CSV di-download (file dibuat pada browser)");
});

/* ----------------- RESET & INPUT REAL ----------------- */
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(!confirm("Reset semua input?")) return;
  document.querySelectorAll("input,select").forEach(el=>{
    if(el.type==="checkbox") el.checked = false;
    else el.value = "";
  });
  HISTORY = [];
  renderHistory();
  document.getElementById("resultText").textContent = "";
  document.getElementById("scoreDist").textContent = "";
  document.getElementById("trendText").textContent = "";
  showToast("Input dikosongkan");
});

document.getElementById("inputRealBtn").addEventListener("click", ()=>{
  const h = prompt("Gol Home (angka):","");
  const a = prompt("Gol Away (angka):","");
  if(h===null || a===null) return;
  if(HISTORY.length===0){ showToast("Belum ada history untuk kaitkan skor nyata"); return; }
  HISTORY[0].real_home = Number(h);
  HISTORY[0].real_away = Number(a);
  renderHistory();
  showToast("Skor nyata tersimpan pada record terbaru");
});

/* ----------------- AUTO ASSIST BUTTONS ----------------- */
document.getElementById("autoCalcStats").addEventListener("click", ()=>{
  autoConv("h"); autoConv("a"); autoShotsC("h"); autoShotsC("a"); autoCross("h"); autoCross("a"); autoPAF("h"); autoPAF("a");
  showToast("Auto Assist applied");
});
document.getElementById("autoEnhancedBtn").addEventListener("click", async ()=>{
  // enhanced = compute + render
  document.getElementById("analyzeBtn").disabled = true;
  showToast("Menghitung enhanced...");
  await new Promise(r=>setTimeout(r,80));
  mainAnalyze();
  document.getElementById("analyzeBtn").disabled = false;
});

/* ----------------- MONTE CARLO WORKER (OPTIONAL / FALLBACK) ----------------- */
let _workerURL = null;
function buildMCWorker(){
  const code = `
    onmessage = function(e){
      const lh = e.data.lh, la = e.data.la, n = e.data.n;
      function randPoisson(lambda){
        // generate using Knuth
        const L = Math.exp(-lambda);
        let k=0, p=1;
        while(p>L){ k++; p *= Math.random(); }
        return k-1;
      }
      let max = 8;
      const scores = {};
      let ph = 0, pd=0, pa=0;
      for(let i=0;i<n;i++){
        const gh = randPoisson(lh);
        const ga = randPoisson(la);
        const k = gh + "-" + ga;
        scores[k] = (scores[k]||0) + 1;
      }
      // normalize
      for(let k in scores) scores[k] = scores[k]/n;
      let pH=0, pD=0, pA=0;
      for(let key in scores){
        const [gh,ga] = key.split("-").map(x=>parseInt(x));
        if(gh>ga) pH += scores[key];
        else if(gh<ga) pA += scores[key];
        else pD += scores[key];
      }
      postMessage({prob:{home:pH,draw:pD,away:pA},scores:scores});
    };
  `;
  const blob = new Blob([code], {type:"application/javascript"});
  if(_workerURL) URL.revokeObjectURL(_workerURL);
  _workerURL = URL.createObjectURL(blob);
}

function runMCWorker(lh,la,n){
  return new Promise((resolve)=>{
    try{
      if(!_workerURL) buildMCWorker();
      const w = new Worker(_workerURL);
      w.onmessage = (ev)=>{ resolve(ev.data); w.terminate(); };
      w.onerror = ()=>{ resolve(null); w.terminate(); };
      w.postMessage({lh:lh, la:la, n:n||5000});
    }catch(e){
      resolve(null);
    }
  });
}

/* ----------------- INIT ----------------- */
window.addEventListener("load", ()=>{
  buildMCWorker();
  updateTournamentBadge();
  showToast("v20.8 ELITE siap — AutoAdvance aktif",1400);
});

/* ----------------- END SCRIPT & HTML ----------------- */
</script>
</body>
</html>
