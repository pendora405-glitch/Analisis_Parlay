<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Parlay TITAN v40 — Final Hybrid xG & Momentum Neutral Engine</title>
<style>
body {
  background:#111;
  color:#eee;
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:0;
}
h1 {
  text-align:center;
  color:#4fc3f7;
  padding:20px 0;
  margin:0;
  font-size:28px;
}
.container {
  width:92%;
  max-width:1100px;
  margin:20px auto 60px auto;
}
.box {
  background:#1c1c1c;
  padding:18px 20px;
  margin-bottom:22px;
  border-radius:10px;
  border:1px solid #333;
}
h2 {
  margin-top:0;
  color:#80d8ff;
  font-size:22px;
}
label {
  display:block;
  margin-top:8px;
  font-weight:bold;
}
input, textarea, select {
  width:100%;
  padding:9px;
  margin-top:5px;
  border-radius:6px;
  border:1px solid #333;
  background:#222;
  color:#eee;
  font-size:15px;
}
textarea { min-height:60px; }
button {
  padding:10px 16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  margin:6px 4px 6px 0;
}
.btn-main{
  background:#0288d1;
  color:#fff;
}
.btn-clear{
  background:#444;
  color:#ddd;
}
.auto-btn{
  background:#004f75;
  color:#fff;
  padding:8px 12px;
  border-radius:6px;
  margin-top:6px;
  margin-right:6px;
}
#result {
  white-space:pre;
  font-family:Consolas,monospace;
  background:#000;
  padding:12px;
  border-radius:6px;
  min-height:200px;
  border:1px solid #333;
}
.small-note {
  color:#aaa;
  font-size:13px;
  margin-top:8px;
}
</style>
</head>
<body>
<h1>Parlay TITAN v40 — Final Hybrid xG & Momentum Neutral Engine</h1>

<div class="container">

<div class="small-note">
  v40 = final tier: Hybrid xG (xG + xThreat + EDT + Flow), xDef, Low-Block, DM15, Chaos, Pressure Wave, Momentum Swing, Ball Recovery Speed, Predictive Possession.  
  100% netral: tidak pakai odds, tidak condong ke Over/Under atau 1X2 tertentu.
</div>

<!-- =============================== -->
<!--      HOME TEAM PANEL v40        -->
<!-- =============================== -->
<div class="box">
  <h2>HOME TEAM — Statistik Utama</h2>

  <label>Nama Tim</label>
  <input id="h_name">

  <label>Shots Per Game</label>
  <input id="h_shots">

  <label>Shots on Target</label>
  <input id="h_sot">

  <label>xG</label>
  <input id="h_xg">

  <label>Danger Zone xG (DZxG)</label>
  <input id="h_dzxg">

  <label>GK Save Difficulty</label>
  <input id="h_gksv">

  <label>Progression</label>
  <input id="h_prog">

  <label>Final Third Entry</label>
  <input id="h_f3">

  <label>Possession (%)</label>
  <input id="h_poss">

  <label>Goals Conceded</label>
  <input id="h_gc">

  <label>Shots Conceded</label>
  <input id="h_shc">

  <label>Interception</label>
  <input id="h_int">

  <label>REST Days</label>
  <input id="h_rest">

  <label>Absensi (GK:0; DF:0; MD:0; FW:0)</label>
  <textarea id="h_abs"></textarea>

  <h3>Auto Engine</h3>

  <button class="auto-btn" onclick="autoBuildUp('h')">Auto Build-Up</button>
  <input id="h_build">

  <button class="auto-btn" onclick="autoDefense('h')">Auto Defense</button>
  <input id="h_deflvl">

  <button class="auto-btn" onclick="autoImportance('h')">Auto Importance</button>
  <input id="h_imp">

  <button class="auto-btn" onclick="autoRotation('h')">Auto Rotation</button>
  <input id="h_rot">

  <button class="auto-btn" onclick="autoPress('h')">Auto Pressing</button>
  <input id="h_press">

  <button class="auto-btn" onclick="autoFinish('h')">Auto Finishing</button>
  <input id="h_finish">

  <div class="small-note">
    DZxG & GK Save Difficulty boleh kosong bila tidak tersedia.
  </div>
</div>


<!-- =============================== -->
<!--      AWAY TEAM PANEL v40        -->
<!-- =============================== -->
<div class="box">
  <h2>AWAY TEAM — Statistik Utama</h2>

  <label>Nama Tim</label>
  <input id="a_name">

  <label>Shots Per Game</label>
  <input id="a_shots">

  <label>Shots on Target</label>
  <input id="a_sot">

  <label>xG</label>
  <input id="a_xg">

  <label>Danger Zone xG (DZxG)</label>
  <input id="a_dzxg">

  <label>GK Save Difficulty</label>
  <input id="a_gksv">

  <label>Progression</label>
  <input id="a_prog">

  <label>Final Third Entry</label>
  <input id="a_f3">

  <label>Possession (%)</label>
  <input id="a_poss">

  <label>Goals Conceded</label>
  <input id="a_gc">

  <label>Shots Conceded</label>
  <input id="a_shc">

  <label>Interception</label>
  <input id="a_int">

  <label>REST Days</label>
  <input id="a_rest">

  <label>Absensi (GK:0; DF:0; MD:0; FW:0)</label>
  <textarea id="a_abs"></textarea>

  <h3>Auto Engine</h3>

  <button class="auto-btn" onclick="autoBuildUp('a')">Auto Build-Up</button>
  <input id="a_build">

  <button class="auto-btn" onclick="autoDefense('a')">Auto Defense</button>
  <input id="a_deflvl">

  <button class="auto-btn" onclick="autoImportance('a')">Auto Importance</button>
  <input id="a_imp">

  <button class="auto-btn" onclick="autoRotation('a')">Auto Rotation</button>
  <input id="a_rot">

  <button class="auto-btn" onclick="autoPress('a')">Auto Pressing</button>
  <input id="a_press">

  <button class="auto-btn" onclick="autoFinish('a')">Auto Finishing</button>
  <input id="a_finish">

  <div class="small-note">
    Bisa isi statistik dulu, lalu tekan tombol AUTO untuk rating.
  </div>
</div>
<!-- =============================== -->
<!--       MATCH CONTEXT v40         -->
<!-- =============================== -->
<div class="box">
  <h2>Match Context</h2>

  <label>Mode Pertandingan</label>
  <select id="ctx_mode">
    <option value="league">League</option>
    <option value="cup">Cup</option>
    <option value="derby">Derby</option>
    <option value="relegation">Relegation Battle</option>
    <option value="intl">International</option>
  </select>

  <label>Weather</label>
  <select id="ctx_weather">
    <option value="clear">Clear</option>
    <option value="rain">Rain</option>
    <option value="storm">Storm</option>
    <option value="hot">Hot</option>
    <option value="cold">Cold</option>
  </select>

  <label>Referee Strictness (1–10)</label>
  <input id="ctx_ref">

  <label>Match Tempo Expectation (1–10)</label>
  <input id="ctx_tempo">

  <label>H2H Rating (opsional, 1–10, kosongkan jika tidak dipakai)</label>
  <input id="ctx_h2h">
</div>

<!-- =============================== -->
<!--     CONTROL & RESULT PANEL      -->
<!-- =============================== -->
<div class="box">
  <h2>Kontrol</h2>
  <button class="btn-main" onclick="analyze_v40()">ANALYZE v40</button>
  <button class="btn-clear" onclick="clearAll_v40()">CLEAR</button>
  <div class="small-note">
    ANALYZE v40 = menjalankan semua modul (Hybrid-xG, Tactical, DM15, Chaos, Low-Block, BRS, Possession, dsb).  
    CLEAR = menghapus semua input dan hasil.
  </div>
</div>

<div class="box">
  <h2>Hasil Analisis v40</h2>
  <div id="result">Hasil akan muncul di sini...</div>
</div>

<!-- =============================== -->
<!--      CORE HELPER + AUTO v40     -->
<!-- =============================== -->
<script>
function toNum(v){
  v = (v ?? "").toString().trim();
  if(v === "" || isNaN(parseFloat(v))) return 0;
  return parseFloat(v);
}
function clamp(x,min,max){ return Math.min(Math.max(x,min),max); }
function get(id){ const el=document.getElementById(id); return el?el.value.trim():""; }
function setVal(id,v){ const el=document.getElementById(id); if(el) el.value=v; }

function parseAbs(txt){
  let o={GK:0,DF:0,MD:0,FW:0};
  if(!txt) return o;
  txt.split(";").forEach(s=>{
    let p=s.split(":");
    if(p.length===2){
      let k=p[0].trim().toUpperCase();
      if(o[k]!==undefined) o[k]=toNum(p[1]);
    }
  });
  return o;
}

/* AUTO ENGINE v40 */

function autoBuildUp(t){
  let shots=toNum(get(t+"_shots"));
  let prog =toNum(get(t+"_prog"));
  let f3   =toNum(get(t+"_f3"));
  let poss =toNum(get(t+"_poss"));
  let raw=(shots*0.22)+(prog*0.28)+(f3*0.30)+(poss*0.20);
  setVal(t+"_build",clamp(raw/4.8,1,10).toFixed(1));
}
function autoDefense(t){
  let gc  =toNum(get(t+"_gc"));
  let shc =toNum(get(t+"_shc"));
  let gksv=toNum(get(t+"_gksv"));
  let intc=toNum(get(t+"_int"));
  let raw=((11-gc)*0.32)+((11-shc)*0.24)+(gksv*0.26)+(intc*0.18);
  setVal(t+"_deflvl",clamp(raw/4.8,1,10).toFixed(1));
}
function autoImportance(t){
  let mode=get("ctx_mode");
  let rest=toNum(get(t+"_rest"));
  let abs=parseAbs(get(t+"_abs"));
  let count=abs.GK+abs.DF+abs.MD+abs.FW;
  let base=5;
  if(mode==="cup") base+=2;
  if(mode==="derby") base+=2.5;
  if(mode==="relegation") base+=3;
  if(mode==="intl") base+=1.5;
  base+=(rest>=4?0.5:-0.3);
  base-=clamp(count*0.25,0,2.5);
  setVal(t+"_imp",clamp(base,1,10).toFixed(1));
}
function autoRotation(t){
  let rest=toNum(get(t+"_rest"));
  let abs=parseAbs(get(t+"_abs"));
  let count=abs.GK+abs.DF+abs.MD+abs.FW;
  let raw=(11-rest)*0.4+count*0.6;
  setVal(t+"_rot",clamp(raw/2.4,1,10).toFixed(1));
}
function autoPress(t){
  let f3=toNum(get(t+"_f3"));
  let prog=toNum(get(t+"_prog"));
  let sot=toNum(get(t+"_sot"));
  let intc=toNum(get(t+"_int"));
  let raw=(f3*0.32)+(intc*0.28)+(prog*0.20)+(sot*0.20);
  setVal(t+"_press",clamp(raw/4.9,1,10).toFixed(1));
}
function autoFinish(t){
  let xg=toNum(get(t+"_xg"));
  let sot=toNum(get(t+"_sot"));
  let shots=toNum(get(t+"_shots"));
  let raw=(sot*0.34)+(xg*0.40)+(shots*0.26);
  setVal(t+"_finish",clamp(raw/5.0,1,10).toFixed(1));
}
</script>
<!-- =============================== -->
<!--      TACTICAL ENGINE v40        -->
<!-- =============================== -->
<script>
/* PHASES & BASIC TACTICAL */

function phaseDef_v40(t){
  let raw=((11-t.gc)*0.30)+((11-t.shc)*0.24)+(t.gksv*0.26)+(t.intc*0.20);
  return clamp(raw/4.8,1,10);
}
function phaseMid_v40(t){
  let raw=(t.prog*0.50)+(t.f3*0.50);
  return clamp(raw/5.0,1,10);
}
function phaseAtk_v40(t){
  let raw=(t.xg*0.38)+(t.sot*0.32)+(t.finish*0.30);
  return clamp(raw/4.4,1,10);
}
function xThreat_v40(t){
  let raw=(t.f3*0.32)+(t.prog*0.22)+(t.xg*0.28)+(t.sot*0.18);
  return clamp(raw/4.6,1,10);
}
function boxCtrl_v40(t){
  let raw=((11-t.gc)*0.28)+((11-t.shc)*0.22)+(t.intc*0.24)+(t.gksv*0.26);
  return clamp(raw/4.8,1,10);
}
function overload_v40(t){
  let raw=(t.f3*0.45)+(t.prog*0.28)+(t.poss*0.27);
  return clamp(raw/4.8,1,10);
}
function antiPress_v40(t){
  let raw=(t.build*0.55)+(t.prog*0.45);
  return clamp(raw/5.0,1,10);
}
function transPress_v40(t){
  let raw=(t.press*0.55)+(t.intc*0.45);
  return clamp(raw/5.0,1,10);
}
function fTilt_v40(h,a){
  let tilt=(h.f3+h.prog)-(a.f3+a.prog);
  return clamp((tilt/25)+5,1,10);
}

/* ADVANCED: EDT, xDef, BRS, xCarry, FlowRisk */

function edt_v40(t){
  let dz=t.dzxg||0;
  let raw=(t.xThreat*0.40)+(t.f3*0.18)+(t.prog*0.14)+(t.overload*0.14)+(dz*0.32)+(t.atkPhase*0.18);
  return clamp(raw/4.8,1,10);
}
function xDef_v40(t){
  let raw=(t.defPhase*0.30)+(t.boxCtrl*0.28)+((11-t.gc)*0.18)+((11-t.shc)*0.14)+(t.gksv*0.20)+(t.intc*0.14);
  return clamp(raw/4.8,1,10);
}
function brs_v40(t){ // Ball Recovery Speed
  let raw=(t.intc*0.45)+((11-t.shc)*0.30)+(t.transPress*0.25);
  return clamp(raw/4.3,1,10);
}
function xCarry_v40(t){
  let raw=(t.prog*0.40)+(t.f3*0.40)+(t.poss*0.20);
  return clamp(raw/4.8,1,10);
}
function flowRisk_v40(H,A){
  let raw=Math.abs(H.transPress-A.transPress)*0.4+Math.abs(H.antiPress-A.antiPress)*0.3+Math.abs(H.overload-A.overload)*0.3;
  return clamp(raw/2.5,1,10);
}

/* DM15 Momentum */

function dm15_v40(t){
  let base=(t.build*0.30)+(t.f3*0.35)+(t.prog*0.20)+(t.press*0.15);
  let arr=[];
  for(let i=0;i<6;i++){
    let adj=base-(i*0.35);
    arr.push(clamp(adj/3.8,1,10));
  }
  return arr;
}

/* CHAOS, TEMPO, LOW BLOCK */

function tempoConf_v40(H,A,ctx){
  let t=toNum(ctx.t);
  let raw=Math.abs(H.build-A.build)*0.30+Math.abs(H.press-A.press)*0.30+Math.abs(H.poss-A.poss)*0.20+(t*0.20);
  return clamp(raw/2.4,1,10);
}
function chaos_v40(H,A,tempoConf){
  let raw=Math.abs(H.fTilt-A.fTilt)*0.28+Math.abs(H.overload-A.overload)*0.22+(tempoConf*0.50);
  return clamp(raw/2.4,1,10);
}
function lowBlock_v40(t){
  let s=0;
  if(t.defPhase>=7.5) s+=0.35;
  if(t.boxCtrl>=7.0) s+=0.25;
  if(t.fTilt<=4.5) s+=0.20;
  if(t.overload<=4.5 && t.atkPhase<=5.0) s+=0.20;
  return clamp(s,0,1);
}

/* STYLE / EQUALITY / GAME STATE / SHIFT */

function tes_v40(H,A){
  let raw=Math.abs(H.xThreat-A.xThreat)*0.28+Math.abs(H.fTilt-A.fTilt)*0.22+Math.abs(H.overload-A.overload)*0.22+Math.abs(H.atkPhase-A.atkPhase)*0.28;
  return clamp(10-raw,1,10);
}
function style_v40(H,A){
  let raw=(H.build-A.build)*0.20+(H.press-A.press)*0.20+(H.finish-A.finish)*0.20+(H.fTilt-A.fTilt)*0.20+(H.xThreat-A.xThreat)*0.20;
  return clamp(raw/1.2+5,1,10);
}
function gameState_v40(t){
  if(t.xThreat>=7.5 && t.atkPhase>=7) return "dominant attacking";
  if(t.defPhase>=8 && t.xDef>=7) return "strong compact defending";
  if(t.build<=4 && t.press<=4) return "under pressure, sulit keluar";
  if(t.xThreat<=4) return "minim ancaman, build-up berat";
  return "balanced / adaptive";
}
function shift_v40(H,A){
  if(!H.dm15||!A.dm15) return "DM15 tidak tersedia";
  let hE=(H.dm15[0]+H.dm15[1])/2, hL=(H.dm15[4]+H.dm15[5])/2;
  let aE=(A.dm15[0]+A.dm15[1])/2, aL=(A.dm15[4]+A.dm15[5])/2;
  let hS=hL-hE, aS=aL-aE, th=0.8;
  if(Math.abs(hS)<th && Math.abs(aS)<th) return "Momentum relatif stabil untuk kedua tim.";
  if(hS>th && aS<-th) return "Home naik di babak kedua, Away menurun.";
  if(hS<-th && aS>th) return "Away naik di babak kedua, Home menurun.";
  if(hS>th && aS>th) return "Kedua tim lebih agresif di akhir laga.";
  if(hS<-th && aS<-th) return "Keduanya menurun intensitasnya di akhir.";
  return "Perubahan momentum sedang (tidak ekstrem).";
}

/* PRESSURE WAVE & MOMENTUM SWING & POSSESSION */

function tpw_v40(H,A,ctx,chaos,tempoConf){
  let tempo=toNum(ctx.t);
  let raw=(H.transPress+A.transPress)*0.24+(H.press+A.press)*0.22+(H.overload+A.overload)*0.16+tempoConf*0.18+chaos*0.15+tempo*0.05;
  return clamp(raw/3.2,1,10);
}
function ms_v40(H,A){
  if(!H.dm15||!A.dm15) return {amp:0,fav:"Seimbang"};
  let hE=(H.dm15[0]+H.dm15[1])/2, hL=(H.dm15[4]+H.dm15[5])/2;
  let aE=(A.dm15[0]+A.dm15[1])/2, aL=(A.dm15[4]+A.dm15[5])/2;
  let swing=(hL-hE)-(aL-aE);
  let fav="Seimbang";
  if(swing>0.6) fav="Home"; else if(swing<-0.6) fav="Away";
  let amp=clamp(Math.abs(swing)*1.8,0,10);
  return {amp,fav};
}
function poss_v40(H,A){
  let bH=H.build*0.26+H.antiPress*0.20+H.overload*0.18+H.xThreat*0.16+H.poss*0.20;
  let bA=A.build*0.26+A.antiPress*0.20+A.overload*0.18+A.xThreat*0.16+A.poss*0.20;
  let s=bH+bA;
  if(s<=0) return {h:50,a:50};
  let hPct=(bH/s)*100; hPct=clamp(hPct,25,75);
  let aPct=100-hPct;
  return {h:hPct,a:aPct};
}

/* CONTEXT & H2H */

function readCtx_v40(){
  return {
    mode:get("ctx_mode"),
    weather:get("ctx_weather"),
    r:get("ctx_ref"),
    t:get("ctx_tempo"),
    h2h:get("ctx_h2h")
  };
}
function readH2H_v40(v){
  let n=toNum(v);
  if(n<=0) return {has:false};
  return {has:true,rating:clamp(n,1,10)};
}

/* ICM & CONTEXT MOD & LOW-BLOCK & GK Iso */

function ICM_v40(abs){
  let pen=abs.GK*0.60+abs.DF*0.45+abs.MD*0.35+abs.FW*0.40;
  return clamp(1-pen/9,0.70,1.0);
}
function ctxMod_v40(ctx){
  let m=1.0;
  switch(ctx.mode){
    case "league":m*=1.00;break;
    case "cup":m*=0.99;break;
    case "derby":m*=1.03;break;
    case "relegation":m*=1.03;break;
    case "intl":m*=1.01;break;
  }
  switch(ctx.weather){
    case "rain":m*=0.97;break;
    case "storm":m*=0.94;break;
    case "hot":m*=0.96;break;
    case "cold":m*=0.98;break;
  }
  let t=toNum(ctx.t);
  m*=(1+clamp((t-5)/40,-0.06,0.06));
  return clamp(m,0.88,1.12);
}
function gkIso_v40(t,opp){
  let raw=(t.gksv-5)*0.10-(opp.xThreat-5)*0.04-(opp.boxCtrl-5)*0.03;
  return clamp(1+raw,0.80,1.20);
}
</script>
<!-- =============================== -->
<!--  CORE PROBABILITY + ENGINE v40  -->
<!-- =============================== -->
<script>
function factorial(n){n=Math.floor(n);if(n<=1)return 1;let r=1;for(let i=2;i<=n;i++)r*=i;return r;}
function poisson(lambda,k){if(lambda<=0)lambda=0.0001;return Math.pow(lambda,k)*Math.exp(-lambda)/factorial(k);}
function prob3W(lH,lA){
  let pH=0,pD=0,pA=0;
  for(let i=0;i<=10;i++){
    for(let j=0;j<=10;j++){
      const p=poisson(lH,i)*poisson(lA,j);
      if(i>j)pH+=p; else if(i===j)pD+=p; else pA+=p;
    }
  }
  return {home:pH,draw:pD,away:pA};
}
function ouProb_v40(lH,lA,line){
  let over=0,under=0;
  for(let i=0;i<=10;i++){
    for(let j=0;j<=10;j++){
      const p=poisson(lH,i)*poisson(lA,j);
      if(i+j>line)over+=p;else under+=p;
    }
  }
  const s=over+under||1;
  return {over:over/s,under:under/s};
}
function btts_v40(lH,lA){
  let yes=0,no=0;
  for(let i=0;i<=10;i++){
    for(let j=0;j<=10;j++){
      const p=poisson(lH,i)*poisson(lA,j);
      if(i>0 && j>0) yes+=p; else no+=p;
    }
  }
  return {yes,no};
}
function scores_v40(lH,lA){
  let arr=[];
  for(let i=0;i<=6;i++){
    for(let j=0;j<=6;j++){
      const p=poisson(lH,i)*poisson(lA,j);
      arr.push({h:i,a:j,p});
    }
  }
  arr.sort((x,y)=>y.p-x.p);
  return arr.slice(0,8);
}
function cards_v40(H,A,ctx,chaos){
  let raw=(H.press+A.press)*0.22+toNum(ctx.r)*0.28+chaos*0.25;
  return clamp(raw/2.2,1,10);
}
function corners_v40(t){
  let raw=(t.shots*0.25)+(t.sot*0.25)+(t.prog*0.25)+(t.f3*0.25);
  return clamp(raw/3.0,1,15);
}
function varModel_v40(lambdaBase,chaos,tempoConf){
  const vol=clamp((chaos*0.6+tempoConf*0.4)/2.5,0.8,1.8);
  const high=clamp(lambdaBase*(1+(vol-1)*0.6),0.05,6.0);
  const low =clamp(lambdaBase*(1-(vol-1)*0.6),0.05,6.0);
  return {low,base:lambdaBase,high};
}

/* BUILD TEAM v40 */

function buildTeam_v40(p){
  const abs=parseAbs(get(p+"_abs"));
  let t={
    name:get(p+"_name")||(p==="h"?"HOME":"AWAY"),
    shots:toNum(get(p+"_shots")),
    sot:toNum(get(p+"_sot")),
    xg:toNum(get(p+"_xg")),
    dzxg:toNum(get(p+"_dzxg")),
    gksv:toNum(get(p+"_gksv")),
    prog:toNum(get(p+"_prog")),
    f3:toNum(get(p+"_f3")),
    poss:toNum(get(p+"_poss")),
    gc:toNum(get(p+"_gc")),
    shc:toNum(get(p+"_shc")),
    intc:toNum(get(p+"_int")),
    rest:toNum(get(p+"_rest"))||3,
    abs:abs,
    build:toNum(get(p+"_build")),
    deflvl:toNum(get(p+"_deflvl")),
    imp:toNum(get(p+"_imp")),
    rot:toNum(get(p+"_rot")),
    press:toNum(get(p+"_press")),
    finish:toNum(get(p+"_finish"))
  };
  if(!t.poss)t.poss=50;
  if(!t.build)t.build=5;
  if(!t.deflvl)t.deflvl=5;
  if(!t.imp)t.imp=5;
  if(!t.rot)t.rot=5;
  if(!t.press)t.press=5;
  if(!t.finish)t.finish=5;
  return t;
}

/* HYBRID-xG v40 */

function hybridXG_v40(t,opp,flowR){
  const dz=t.dzxg||0;
  const base=(t.xg*0.45)+(t.edt*0.30)+(t.xThreat*0.18)+(t.xCarry*0.12)+(dz*0.30)-(opp.xDef*0.25)-(flowR*0.15);
  return clamp(base/4.6,0.2,4.8);
}

/* REL / RISK / COLL / NCG */

function rel_v40(t,chaos){
  let raw=(t.xThreat*0.22)+(t.edt*0.22)+(t.xDef*0.20)+(t.boxCtrl*0.14)+(t.build*0.12)-(chaos*0.10);
  return clamp(raw/3.8,1,10);
}
function risk_v40(H,A,chaos){
  let raw=chaos*0.45+Math.abs(H.fTilt-A.fTilt)*0.25+Math.abs(H.overload-A.overload)*0.20;
  return clamp(raw/2.2,1,10);
}
function coll_v40(t,risk){
  let raw=((11-t.deflvl)*0.30)+((11-t.xDef)*0.26)+(risk*0.24);
  return clamp(raw/2.1,1,10);
}
function ncg_v40(rel,chaos){
  const s=rel*0.7-chaos*0.3;
  if(s>=7.8)return "A+";
  if(s>=6.8)return "A";
  if(s>=5.8)return "B";
  if(s>=4.5)return "C";
  if(s>=3.5)return "D";
  return "E";
}

/* PENALTY-ZONE RISK */

function penRisk_v40(H,A,ctx,chaos,tempoConf){
  let raw=(H.press+A.press)*0.16+(H.boxCtrl+A.boxCtrl)*0.10+(H.transPress+A.transPress)*0.10+chaos*0.14+tempoConf*0.08+toNum(ctx.r)*0.18+(ctx.mode==="derby"?1.2:0)+(ctx.mode==="relegation"?0.8:0)+(ctx.mode==="cup"?0.4:0);
  return clamp(raw/2.2,1,10);
}

/* MAIN ANALYZE v40 */

function analyze_v40(){
  const H=buildTeam_v40("h");
  const A=buildTeam_v40("a");
  const ctx=readCtx_v40();
  const h2h=readH2H_v40(ctx.h2h);

  // phases & tactical
  H.defPhase=phaseDef_v40(H); A.defPhase=phaseDef_v40(A);
  H.midPhase=phaseMid_v40(H); A.midPhase=phaseMid_v40(A);
  H.atkPhase=phaseAtk_v40(H); A.atkPhase=phaseAtk_v40(A);
  H.boxCtrl=boxCtrl_v40(H);   A.boxCtrl=boxCtrl_v40(A);
  H.overload=overload_v40(H); A.overload=overload_v40(A);
  H.antiPress=antiPress_v40(H);A.antiPress=antiPress_v40(A);
  H.transPress=transPress_v40(H);A.transPress=transPress_v40(A);
  H.xThreat=xThreat_v40(H);   A.xThreat=xThreat_v40(A);
  H.fTilt=fTilt_v40(H,A);     A.fTilt=fTilt_v40(A,H);
  H.dm15=dm15_v40(H);         A.dm15=dm15_v40(A);

  const tConf=tempoConf_v40(H,A,ctx);
  const chaos=chaos_v40(H,A,tConf);

  H.edt=edt_v40(H); A.edt=edt_v40(A);
  H.xDef=xDef_v40(H);A.xDef=xDef_v40(A);
  H.boxCtrl=boxCtrl_v40(H);A.boxCtrl=boxCtrl_v40(A);
  H.transPress=transPress_v40(H);A.transPress=transPress_v40(A);
  H.brSpeed=brs_v40(H);A.brSpeed=brs_v40(A);
  H.xCarry=xCarry_v40(H);A.xCarry=xCarry_v40(A);

  const flowR=flowRisk_v40(H,A);
  const lbH=lowBlock_v40(H), lbA=lowBlock_v40(A);
  const ctxM=ctxMod_v40(ctx);
  const icmH=ICM_v40(H.abs), icmA=ICM_v40(A.abs);
  const gkIsoH=gkIso_v40(H,A), gkIsoA=gkIso_v40(A,H);

  // Hybrid-xG
  let baseXH=hybridXG_v40(H,A,flowR)*icmH*ctxM;
  let baseXA=hybridXG_v40(A,H,flowR)*icmA*ctxM;
  baseXH*=(1-lbA*0.15);
  baseXA*=(1-lbH*0.15);
  if(h2h.has){
    const adj=(h2h.rating-5)/5;
    const safe=clamp(adj*0.07,-0.07,0.07);
    baseXH*=(1+safe);
    baseXA*=(1-safe);
  }
  baseXH=clamp(baseXH,0.05,5.0);
  baseXA=clamp(baseXA,0.05,5.0);

  const varH=varModel_v40(baseXH,chaos,tConf);
  const varA=varModel_v40(baseXA,chaos,tConf);
  const lH=clamp(varH.base,0.05,5.5);
  const lA=clamp(varA.base,0.05,5.5);

  const p3=prob3W(lH,lA);
  const lineOU=2.5;
  const ou=ouProb_v40(lH,lA,lineOU);
  const bt=btts_v40(lH,lA);
  const scoreTop=scores_v40(lH,lA);
  const cardsI=cards_v40(H,A,ctx,chaos);
  const cornersH=corners_v40(H);
  const cornersA=corners_v40(A);

  const relH=rel_v40(H,chaos), relA=rel_v40(A,chaos);
  const riskH=risk_v40(H,A,chaos), riskA=risk_v40(A,H,chaos);
  const colH=coll_v40(H,riskH), colA=coll_v40(A,riskA);
  const ncgH=ncg_v40(relH,chaos), ncgA=ncg_v40(relA,chaos);

  const tes=tes_v40(H,A);
  const style=style_v40(H,A);
  const gameH=gameState_v40(H), gameA=gameState_v40(A);
  const shift=shift_v40(H,A);
  const tpw=tpw_v40(H,A,ctx,chaos,tConf);
  const ms=ms_v40(H,A);
  const poss=poss_v40(H,A);
  const penR=penRisk_v40(H,A,ctx,chaos,tConf);

  render_v40({
    H,A,
    ctx,
    lH,lA,
    varH,varA,
    p3,ou,bt,
    lineOU,
    scores:scoreTop,
    cardsI,
    cornersH,cornersA,
    relH,relA,
    riskH,riskA,
    colH,colA,
    ncgH,ncgA,
    chaos,tConf,
    lbH,lbA,
    gkIsoH,gkIsoA,
    tes,style,gameH,gameA,
    shift,tpw,ms,poss,
    penR,
    h2h
  });
}

/* RENDER v40 */

function render_v40(R){
  const H=R.H,A=R.A;
  let out="";
  out+=`MATCH: ${H.name} vs ${A.name}\n`;
  out+=`============================================\n\n`;
  out+=`EXPECTED GOALS v40 (Hybrid-xG)\n`;
  out+=`λ Home: ${R.lH.toFixed(3)} (Range: ${R.varH.low.toFixed(2)} – ${R.varH.high.toFixed(2)})\n`;
  out+=`λ Away: ${R.lA.toFixed(3)} (Range: ${R.varA.low.toFixed(2)} – ${R.varA.high.toFixed(2)})\n\n`;
  out+=`=== 1X2 (murni Poisson dari λ, netral) ===\n`;
  out+=`Home : ${(R.p3.home*100).toFixed(1)}%\n`;
  out+=`Draw : ${(R.p3.draw*100).toFixed(1)}%\n`;
  out+=`Away : ${(R.p3.away*100).toFixed(1)}%\n\n`;
  out+=`=== Over / Under (Line ${R.lineOU.toFixed(1)}) ===\n`;
  out+=`Over : ${(R.ou.over*100).toFixed(1)}%\n`;
  out+=`Under: ${(R.ou.under*100).toFixed(1)}%\n\n`;
  out+=`=== BTTS ===\n`;
  out+=`YES : ${(R.bt.yes*100).toFixed(1)}%\n`;
  out+=`NO  : ${(R.bt.no*100).toFixed(1)}%\n\n`;
  out+=`=== Tactical Phase (1–10) ===\n`;
  out+=`Def Phase : Home ${H.defPhase.toFixed(1)} | Away ${A.defPhase.toFixed(1)}\n`;
  out+=`Mid Phase : Home ${H.midPhase.toFixed(1)} | Away ${A.midPhase.toFixed(1)}\n`;
  out+=`Atk Phase : Home ${H.atkPhase.toFixed(1)} | Away ${A.atkPhase.toFixed(1)}\n\n`;
  out+=`=== xThreat, EDT, xDef, Box, Tilt, Carry ===\n`;
  out+=`xThreat : Home ${H.xThreat.toFixed(1)} | Away ${A.xThreat.toFixed(1)}\n`;
  out+=`EDT     : Home ${H.edt.toFixed(1)} | Away ${A.edt.toFixed(1)}\n`;
  out+=`xDef    : Home ${H.xDef.toFixed(1)} | Away ${A.xDef.toFixed(1)}\n`;
  out+=`BoxCtrl : Home ${H.boxCtrl.toFixed(1)} | Away ${A.boxCtrl.toFixed(1)}\n`;
  out+=`FieldTilt: Home ${H.fTilt.toFixed(1)} /10 | Away ${A.fTilt.toFixed(1)} /10\n`;
  out+=`xCarry  : Home ${H.xCarry.toFixed(1)} | Away ${A.xCarry.toFixed(1)}\n\n`;
  out+=`=== Overload / Anti-Press / TransPress / BRS ===\n`;
  out+=`Overload   : Home ${H.overload.toFixed(1)} | Away ${A.overload.toFixed(1)}\n`;
  out+=`Anti-Press : Home ${H.antiPress.toFixed(1)} | Away ${A.antiPress.toFixed(1)}\n`;
  out+=`TransPress : Home ${H.transPress.toFixed(1)} | Away ${A.transPress.toFixed(1)}\n`;
  out+=`Ball Recovery Speed (BRS): Home ${H.brSpeed.toFixed(1)} | Away ${A.brSpeed.toFixed(1)}\n\n`;
  out+=`=== DM15 (Dynamic Momentum 15') ===\n`;
  out+=`Home  0–15 : ${H.dm15[0].toFixed(1)} | 15–30 : ${H.dm15[1].toFixed(1)} | 30–45 : ${H.dm15[2].toFixed(1)}\n`;
  out+=`Home 45–60 : ${H.dm15[3].toFixed(1)} | 60–75 : ${H.dm15[4].toFixed(1)} | 75–90 : ${H.dm15[5].toFixed(1)}\n`;
  out+=`Away  0–15 : ${A.dm15[0].toFixed(1)} | 15–30 : ${A.dm15[1].toFixed(1)} | 30–45 : ${A.dm15[2].toFixed(1)}\n`;
  out+=`Away 45–60 : ${A.dm15[3].toFixed(1)} | 60–75 : ${A.dm15[4].toFixed(1)} | 75–90 : ${A.dm15[5].toFixed(1)}\n\n`;
  out+=`=== Low-Block & GK Isolation ===\n`;
  out+=`Low-Block Index Home: ${R.lbH.toFixed(2)} (0–1)\n`;
  out+=`Low-Block Index Away: ${R.lbA.toFixed(2)} (0–1)\n`;
  out+=`GK Isolation Home: ${R.gkIsoH.toFixed(2)}\n`;
  out+=`GK Isolation Away: ${R.gkIsoA.toFixed(2)}\n\n`;
  out+=`=== Cards & Corners (indikatif) ===\n`;
  out+=`Cards Intensity: ${R.cardsI.toFixed(1)} /10\n`;
  out+=`Corners Relatif — Home: ${R.cornersH.toFixed(1)} | Away: ${R.cornersA.toFixed(1)}\n\n`;
  out+=`=== Penalty-Zone Risk v40 ===\n`;
  out+=`Risiko Penalti (1–10): ${R.penR.toFixed(1)}\n\n`;
  out+=`=== Predictive Possession & Pressure Wave v40 ===\n`;
  out+=`Expected Possession: Home ~ ${R.poss.h.toFixed(1)}% | Away ~ ${R.poss.a.toFixed(1)}%\n`;
  out+=`Tactical Pressure Wave: ${R.tpw.toFixed(1)} /10\n\n`;
  out+=`=== Momentum Swing v40 ===\n`;
  out+=`Amplitude Swing: ${R.ms.amp.toFixed(1)} /10\n`;
  out+=`Momentum cenderung: ${R.ms.fav}\n\n`;
  out+=`=== Top Scorelines v40 ===\n`;
  R.scores.forEach(s=>{ out+=`${s.h}-${s.a} : ${(s.p*100).toFixed(2)}%\n`; });
  out+=`\n`;
  out+=`=== Reliability, Risk, Collapse, NCG ===\n`;
  out+=`Reliability: Home ${R.relH.toFixed(1)} | Away ${R.relA.toFixed(1)}\n`;
  out+=`NCG       : Home ${R.ncgH} | Away ${R.ncgA}\n`;
  out+=`Risk      : Home ${R.riskH.toFixed(1)} | Away ${R.riskA.toFixed(1)}\n`;
  out+=`Collapse  : Home ${R.colH.toFixed(1)} | Away ${R.colA.toFixed(1)}\n\n`;
  out+=`=== Tactical Equality & Style ===\n`;
  out+=`TES (Equality): ${R.tes.toFixed(1)} /10\n`;
  out+=`Style Matrix : ${R.style.toFixed(1)} /10\n`;
  out+=`Game-State Home: ${R.gameH}\n`;
  out+=`Game-State Away: ${R.gameA}\n`;
  out+=`Style Shift: ${R.shift}\n\n`;
  if(R.h2h && R.h2h.has){
    out+=`H2H Rating (opsional): ${R.h2h.rating.toFixed(1)} /10 (pengaruh koreksi kecil)\n\n`;
  }else{
    out+=`H2H: tidak digunakan.\n\n`;
  }
  out+=`Catatan v40:\n`;
  out+=`- Semua hasil murni dari input statistik & konteks terbaru.\n`;
  out+=`- Tidak memakai odds / market dan tidak memaksa Over/Under atau 1X2 tertentu.\n`;
  out+=`- Hybrid-xG + xDef + Low-Block + Chaos menjaga prediksi tetap netral & realistis.\n`;
  document.getElementById("result").textContent=out;
}

/* CLEAR */

function clearAll_v40(){
  document.querySelectorAll("input,textarea").forEach(el=>el.value="");
  document.getElementById("result").textContent="Hasil akan muncul di sini...";
}
</script>

</div>
</body>
</html>
